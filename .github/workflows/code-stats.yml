name: Code Statistics

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0:00 运行
  workflow_dispatch:  # 允许手动触发

jobs:
  stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史
      
      - name: Install tokei
        run: |
          curl -sSL https://github.com/XAMPPRocky/tokei/releases/download/v12.1.2/tokei-x86_64-unknown-linux-gnu.tar.gz | tar xz
          chmod +x tokei
      
      - name: Count lines of code
        run: |
          # 统计当前代码行数
          ./tokei --output json > /tmp/current.json
          
          # 提取总行数
          TOTAL_LINES=$(cat /tmp/current.json | jq '.Total.code')
          TODAY=$(date +%Y-%m-%d)
          
          # 读取或创建历史数据
          mkdir -p .github/stats
          if [ -f .github/stats/history.json ]; then
            # 添加今天的数据
            jq --arg date "$TODAY" --argjson lines "$TOTAL_LINES" \
              '.data += [{"date": $date, "lines": $lines}] | .data |= unique_by(.date)' \
              .github/stats/history.json > /tmp/new_history.json
            mv /tmp/new_history.json .github/stats/history.json
          else
            # 创建新文件
            echo "{\"data\": [{\"date\": \"$TODAY\", \"lines\": $TOTAL_LINES}]}" > .github/stats/history.json
          fi
          
          # 生成语言统计
          ./tokei --output json | jq '{languages: [.[] | select(type == "object") | {name: .name, code: .code, comments: .comments, blanks: .blanks}]}' > .github/stats/languages.json
      
      - name: Generate stats badge
        run: |
          TOTAL=$(cat .github/stats/history.json | jq '.data[-1].lines')
          echo "Total lines: $TOTAL"
          
          # 计算今日增量
          if [ $(cat .github/stats/history.json | jq '.data | length') -gt 1 ]; then
            YESTERDAY=$(cat .github/stats/history.json | jq '.data[-2].lines')
            DIFF=$((TOTAL - YESTERDAY))
            if [ $DIFF -ge 0 ]; then
              DIFF_STR="+$DIFF"
            else
              DIFF_STR="$DIFF"
            fi
          else
            DIFF_STR="+0"
          fi
          
          # 保存摘要
          echo "{\"total\": $TOTAL, \"diff\": \"$DIFF_STR\", \"updated\": \"$(date -Iseconds)\"}" > .github/stats/summary.json
      
      - name: Generate chart SVG
        run: |
          python3 << 'EOF'
          import json
          
          with open('.github/stats/history.json') as f:
              data = json.load(f)['data']
          
          # ========== 图表1: 代码总量趋势图 ==========
          width, height = 800, 400
          padding_left, padding_right = 80, 40
          padding_top, padding_bottom = 60, 60
          chart_width = width - padding_left - padding_right
          chart_height = height - padding_top - padding_bottom
          
          if len(data) < 2:
              trend_svg = f'''<svg width="{width}" height="{height}" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#ffffff"/>
                <text x="{width//2}" y="{height//2}" fill="#666" text-anchor="middle" font-family="sans-serif" font-size="16">数据收集中...</text>
              </svg>'''
              daily_svg = trend_svg
          else:
              lines = [d['lines'] for d in data]
              dates = [d['date'] for d in data]
              min_val = 0
              max_val = max(lines) * 1.1
              val_range = max(max_val - min_val, 1)
              
              # 生成Y轴刻度
              y_ticks = []
              tick_count = 5
              for i in range(tick_count + 1):
                  val = min_val + (val_range * i / tick_count)
                  y = padding_top + chart_height - (i / tick_count) * chart_height
                  if val >= 1000:
                      label = f"{val/1000:.1f}k"
                  else:
                      label = f"{int(val)}"
                  y_ticks.append(f'<text x="{padding_left - 10}" y="{y + 4}" fill="#666" font-size="12" text-anchor="end" font-family="sans-serif">{label}</text>')
                  y_ticks.append(f'<line x1="{padding_left}" y1="{y}" x2="{width - padding_right}" y2="{y}" stroke="#eee" stroke-width="1"/>')
              
              # 生成折线点和填充区域
              points = []
              for i, val in enumerate(lines):
                  x = padding_left + (i / max(len(lines)-1, 1)) * chart_width
                  y = padding_top + chart_height - ((val - min_val) / val_range) * chart_height
                  points.append((x, y))
              
              polyline = " ".join([f"{x},{y}" for x, y in points])
              
              # 填充区域
              fill_points = [f"{padding_left},{padding_top + chart_height}"]
              fill_points.extend([f"{x},{y}" for x, y in points])
              fill_points.append(f"{points[-1][0]},{padding_top + chart_height}")
              fill_polygon = " ".join(fill_points)
              
              # X轴日期标签
              x_labels = []
              label_count = min(6, len(dates))
              for i in range(label_count):
                  idx = int(i * (len(dates) - 1) / max(label_count - 1, 1))
                  x = padding_left + (idx / max(len(dates)-1, 1)) * chart_width
                  date_str = dates[idx][5:]  # MM-DD
                  x_labels.append(f'<text x="{x}" y="{height - 25}" fill="#666" font-size="11" text-anchor="middle" font-family="sans-serif">{date_str}</text>')
              
              trend_svg = f'''<svg width="{width}" height="{height}" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="areaGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#e74c3c;stop-opacity:0.3"/>
                    <stop offset="100%" style="stop-color:#e74c3c;stop-opacity:0.05"/>
                  </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="#ffffff"/>
                
                <!-- 标题 -->
                <text x="{width//2}" y="30" fill="#333" font-size="16" font-weight="bold" text-anchor="middle" font-family="sans-serif">Code History</text>
                
                <!-- 图例 -->
                <rect x="{padding_left}" y="45" width="12" height="12" fill="#e74c3c" rx="2"/>
                <text x="{padding_left + 18}" y="55" fill="#333" font-size="11" font-family="sans-serif">WyRainBow/Resume-Agent</text>
                
                <!-- Y轴标签 -->
                <text x="20" y="{padding_top + chart_height//2}" fill="#666" font-size="12" text-anchor="middle" font-family="sans-serif" transform="rotate(-90, 20, {padding_top + chart_height//2})">Lines of Code</text>
                
                <!-- 网格线和Y轴刻度 -->
                {"".join(y_ticks)}
                
                <!-- 坐标轴 -->
                <line x1="{padding_left}" y1="{padding_top}" x2="{padding_left}" y2="{padding_top + chart_height}" stroke="#ccc" stroke-width="1"/>
                <line x1="{padding_left}" y1="{padding_top + chart_height}" x2="{width - padding_right}" y2="{padding_top + chart_height}" stroke="#ccc" stroke-width="1"/>
                
                <!-- 填充区域 -->
                <polygon points="{fill_polygon}" fill="url(#areaGrad)"/>
                
                <!-- 折线 -->
                <polyline points="{polyline}" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
                
                <!-- X轴标签 -->
                {"".join(x_labels)}
                <text x="{width//2}" y="{height - 5}" fill="#666" font-size="12" text-anchor="middle" font-family="sans-serif">Date</text>
                
                <!-- 当前值标注 -->
                <circle cx="{points[-1][0]}" cy="{points[-1][1]}" r="4" fill="#e74c3c"/>
                <text x="{points[-1][0] + 8}" y="{points[-1][1] - 8}" fill="#e74c3c" font-size="12" font-weight="bold" font-family="sans-serif">{lines[-1]}</text>
              </svg>'''
              
              # ========== 图表2: 每日新增代码量（固定显示7天） ==========
              from datetime import datetime, timedelta
              
              # 构建最近7天的数据
              today = datetime.strptime(dates[-1], '%Y-%m-%d')
              
              # 创建日期到代码行数的映射
              date_to_lines = {d: l for d, l in zip(dates, lines)}
              
              # 生成最近7天的日期和变化
              daily_dates = []
              daily_changes = []
              for i in range(6, -1, -1):  # 从6天前到今天
                  day = today - timedelta(days=i)
                  day_str = day.strftime('%Y-%m-%d')
                  prev_day = day - timedelta(days=1)
                  prev_day_str = prev_day.strftime('%Y-%m-%d')
                  
                  daily_dates.append(day_str)
                  
                  if day_str in date_to_lines and prev_day_str in date_to_lines:
                      daily_changes.append(date_to_lines[day_str] - date_to_lines[prev_day_str])
                  elif day_str in date_to_lines:
                      daily_changes.append(0)  # 没有前一天数据
                  else:
                      daily_changes.append(0)  # 当天没有数据
              
              max_change = max(max(daily_changes) if daily_changes else 1, abs(min(daily_changes)) if daily_changes else 1, 100)
              
              # 固定7个柱子
              num_bars = 7
              bar_width = 70
              bar_gap = 15
              total_bars_width = num_bars * bar_width + (num_bars - 1) * bar_gap
              start_x = padding_left + (chart_width - total_bars_width) / 2
              
              bars = []
              bar_labels = []
              for i, change in enumerate(daily_changes):
                  x = start_x + i * (bar_width + bar_gap)
                  center_y = 125  # 零线位置
                  
                  if change >= 0:
                      bar_height = max((change / max_change) * 55, 0) if change > 0 else 0
                      y = center_y - bar_height
                      color = "#27ae60"
                  else:
                      bar_height = max((abs(change) / max_change) * 55, 2)
                      y = center_y
                      color = "#e74c3c"
                  
                  # 绘制柱子（即使是0也画一个小的灰色占位）
                  if bar_height > 0:
                      bars.append(f'<rect x="{x}" y="{y}" width="{bar_width}" height="{bar_height}" fill="{color}" rx="3"/>')
                  else:
                      bars.append(f'<rect x="{x}" y="{center_y - 1}" width="{bar_width}" height="2" fill="#ddd" rx="1"/>')
                  
                  # 日期标签
                  bar_labels.append(f'<text x="{x + bar_width/2}" y="210" fill="#666" font-size="10" text-anchor="middle" font-family="sans-serif">{daily_dates[i][5:]}</text>')
              
              daily_svg = f'''<svg width="{width}" height="250" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#ffffff"/>
                
                <!-- 标题 -->
                <text x="{width//2}" y="30" fill="#333" font-size="16" font-weight="bold" text-anchor="middle" font-family="sans-serif">Daily Changes</text>
                
                <!-- 图例 -->
                <rect x="{padding_left}" y="45" width="12" height="12" fill="#27ae60" rx="2"/>
                <text x="{padding_left + 18}" y="55" fill="#333" font-size="11" font-family="sans-serif">新增</text>
                <rect x="{padding_left + 60}" y="45" width="12" height="12" fill="#e74c3c" rx="2"/>
                <text x="{padding_left + 78}" y="55" fill="#333" font-size="11" font-family="sans-serif">减少</text>
                
                <!-- 零线 -->
                <line x1="{padding_left}" y1="125" x2="{width - padding_right}" y2="125" stroke="#999" stroke-width="1" stroke-dasharray="4"/>
                <text x="{padding_left - 10}" y="129" fill="#666" font-size="11" text-anchor="end" font-family="sans-serif">0</text>
                
                <!-- 柱状图 -->
                {"".join(bars)}
                
                <!-- 日期标签 -->
                {"".join(bar_labels)}
                
                <!-- 最新变化标注 -->
                <text x="{width - padding_right}" y="55" fill="{'#27ae60' if daily_changes[-1] >= 0 else '#e74c3c'}" font-size="14" font-weight="bold" text-anchor="end" font-family="sans-serif">今日: {'+' if daily_changes[-1] >= 0 else ''}{daily_changes[-1]} 行</text>
              </svg>'''
          
          with open('.github/stats/chart.svg', 'w') as f:
              f.write(trend_svg)
          
          with open('.github/stats/daily.svg', 'w') as f:
              f.write(daily_svg)
          EOF
      
      - name: Generate contributors chart
        run: |
          python3 << 'EOF'
          import subprocess
          
          # 获取贡献者统计
          result = subprocess.run('''
          git log --format='%aN' | sort -u | while read author; do
            added=$(git log --author="$author" --pretty=tformat: --numstat 2>/dev/null | awk '{ add += $1 } END { print add+0 }')
            deleted=$(git log --author="$author" --pretty=tformat: --numstat 2>/dev/null | awk '{ del += $2 } END { print del+0 }')
            commits=$(git rev-list --author="$author" --count HEAD 2>/dev/null || echo 0)
            echo "$author|$added|$deleted|$commits"
          done
          ''', shell=True, capture_output=True, text=True)
          
          contributors = []
          for line in result.stdout.strip().split('\n'):
              if '|' in line:
                  parts = line.split('|')
                  if len(parts) == 4:
                      name, added, deleted, commits = parts
                      if 'bot' in name.lower() or (int(added or 0) == 0 and int(deleted or 0) == 0):
                          continue
                      contributors.append({
                          'name': name,
                          'added': int(added or 0),
                          'deleted': int(deleted or 0),
                          'commits': int(commits or 0),
                          'net': int(added or 0) - int(deleted or 0)
                      })
          
          # 合并同一用户的多个账号，并只保留自己的贡献
          merged = {}
          allowed_names = ['wy770', 'WyRainBow']
          
          for c in contributors:
              key = c['name']
              # 只处理允许的用户名
              if key not in allowed_names:
                  continue
              
              # 统一使用 WyRainBow 作为显示名称
              display_name = 'WyRainBow'
              
              if display_name in merged:
                  merged[display_name]['added'] += c['added']
                  merged[display_name]['deleted'] += c['deleted']
                  merged[display_name]['commits'] += c['commits']
                  merged[display_name]['net'] += c['added'] - c['deleted']
              else:
                  merged[display_name] = {
                      'name': display_name,
                      'added': c['added'],
                      'deleted': c['deleted'],
                      'commits': c['commits'],
                      'net': c['added'] - c['deleted']
                  }
          
          contributors = sorted(merged.values(), key=lambda x: x['net'], reverse=True)
          
          # 生成 SVG
          width, height = 600, 60 + max(len(contributors) * 80, 140)
          
          if not contributors:
              # 如果没有贡献者，显示提示信息
              svg = f'''<svg width="{width}" height="{height}" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#ffffff"/>
                <text x="{width//2}" y="{height//2}" fill="#666" text-anchor="middle" font-family="sans-serif" font-size="16">暂无贡献数据</text>
              </svg>'''
              with open('.github/stats/contributors.svg', 'w') as f:
                  f.write(svg)
              exit(0)
          
          max_net = max(c['net'] for c in contributors) if contributors else 1
          colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6']
          
          svg_parts = [f'''<svg width="{width}" height="{height}" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#ffffff"/>
            <text x="{width//2}" y="30" fill="#333" font-size="16" font-weight="bold" text-anchor="middle" font-family="sans-serif">Contributors</text>
          ''']
          
          bar_max_width = 350
          for i, c in enumerate(contributors):
              y_base = 60 + i * 80
              color = colors[i % len(colors)]
              bar_width = max((c['net'] / max_net) * bar_max_width, 20) if max_net > 0 else 20
              
              svg_parts.append(f'''
            <circle cx="40" cy="{y_base + 25}" r="25" fill="{color}" opacity="0.2"/>
            <text x="40" y="{y_base + 32}" fill="{color}" font-size="20" font-weight="bold" text-anchor="middle" font-family="sans-serif">{c['name'][0].upper()}</text>
            <text x="80" y="{y_base + 15}" fill="#333" font-size="14" font-weight="bold" font-family="sans-serif">{c['name']}</text>
            <text x="80" y="{y_base + 32}" fill="#666" font-size="11" font-family="sans-serif">{c['commits']} commits</text>
            <rect x="200" y="{y_base + 8}" width="{bar_width}" height="20" fill="{color}" rx="4"/>
            <text x="{205 + bar_width}" y="{y_base + 22}" fill="#333" font-size="12" font-weight="bold" font-family="sans-serif">+{c['net']}</text>
            <text x="200" y="{y_base + 48}" fill="#27ae60" font-size="10" font-family="sans-serif">+{c['added']}</text>
            <text x="270" y="{y_base + 48}" fill="#e74c3c" font-size="10" font-family="sans-serif">-{c['deleted']}</text>
          ''')
          
          svg_parts.append('</svg>')
          
          with open('.github/stats/contributors.svg', 'w') as f:
              f.write(''.join(svg_parts))
          EOF
      
      - name: Commit stats
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/stats/
          git diff --staged --quiet || git commit -m "chore: update code statistics [skip ci]"
          # 使用 merge 策略推送，避免 rebase 冲突
          git pull --no-rebase origin main || true
          git push || echo "推送失败，可能有冲突，跳过本次更新"
