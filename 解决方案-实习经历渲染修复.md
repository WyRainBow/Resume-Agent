# 解决方案：实习经历渲染修复

## 问题描述

用户反馈：**实习经历没有渲染成功**

PDF 预览中实习经历部分显示为空白，没有任何内容。

## 问题排查过程

### 1. 检查生成的 LaTeX 代码

运行测试脚本检查 LaTeX 输出：

```python
from backend.latex_generator import json_to_latex
latex_code = json_to_latex(resume_data)
```

发现实习经历部分生成了**空的内容**：

```latex
\section{实习经历}
\datedsubsection{\textbf{}}{}    # ← 标题和日期都是空的！
\datedsubsection{\textbf{}}{}
\datedsubsection{\textbf{}}{}
```

### 2. 追踪数据流

检查 JSON 标准化前后的数据变化：

**原始 JSON（正确）**：
```json
{
  "date": "2025.06 - 2025.10",
  "title": "实习经历一",
  "subtitle": "某职位"
}
```

**标准化后（错误）**：
```json
{
  "duration": "2025.06 - 2025.10",
  "position": "某职位"
}
```

**问题发现**：`title` 字段丢失了！

### 3. 定位问题代码

问题出在 `backend/json_normalizer.py` 的 `_standardize_experience_list` 函数：

```python
# 错误的映射逻辑（第 295 行）
elif any(k in key_lower for k in ['职位', 'position', '岗位', 'title', '标题']):
    standardized_item['position'] = value
```

**问题**：把 `title` 字段也映射到了 `position`！

这导致：
1. 先处理 `title` → 映射到 `position`
2. 再处理 `subtitle` → 保留原样
3. 最终 `title` 被覆盖丢失

### 4. 对比 LaTeX 模板期望

`latex_generator.py` 中实习经历的渲染逻辑（第 258-269 行）：

```python
for it in internships:
    title = it.get('title') or ''       # ← 期望 title 字段
    subtitle = it.get('subtitle') or '' # ← 期望 subtitle 字段
    date = it.get('date') or ''         # ← 期望 date 字段
    
    latex_content.append(f"\\datedsubsection{{\\textbf{{{title}}} - {subtitle}}}{{{date}}}")
```

**结论**：LaTeX 模板期望 `title/subtitle/date`，但标准化器错误地把它们转换成了 `company/position/duration`。

## 解决方案

修改 `backend/json_normalizer.py` 的 `_standardize_experience_list` 函数：

### 修改前（错误）

```python
for key, value in item.items():
    key_lower = key.lower()
    
    if any(k in key_lower for k in ['公司', 'company', '单位']):
        standardized_item['company'] = value
    elif any(k in key_lower for k in ['职位', 'position', '岗位', 'title', '标题']):
        standardized_item['position'] = value  # ← title 被错误映射！
    elif any(k in key_lower for k in ['时间', 'duration', 'date', 'period']):
        standardized_item['duration'] = value
```

### 修改后（正确）

```python
for key, value in item.items():
    key_lower = key.lower()
    
    # 保留 title/subtitle/date 字段（internships 格式）
    if key_lower == 'title':
        standardized_item['title'] = value
    elif key_lower == 'subtitle':
        standardized_item['subtitle'] = value
    elif key_lower == 'date':
        standardized_item['date'] = value
    # 映射 company/position/duration（experience 格式）
    elif any(k in key_lower for k in ['公司', 'company', '单位']):
        standardized_item['company'] = value
    elif any(k in key_lower for k in ['职位', 'position', '岗位']):
        standardized_item['position'] = value
    elif any(k in key_lower for k in ['时间', 'duration', 'period']):
        standardized_item['duration'] = value
```

### 核心改进

1. **优先保留原始字段名**：如果字段名是 `title`、`subtitle`、`date`，直接保留
2. **分离 internships 和 experience 格式**：
   - `internships` 使用 `title/subtitle/date`
   - `experience` 使用 `company/position/duration`
3. **避免字段覆盖**：不再把 `title` 映射到 `position`

## 验证结果

修复后，LaTeX 正确生成实习经历：

```latex
\section{实习经历}
\datedsubsection{\textbf{实习经历一} - 某职位}{2025.06 - 2025.10}
\datedsubsection{\textbf{实习经历二} - 某职位}{2025.02 - 2025.06}
\datedsubsection{\textbf{实习经历三} - 某职位}{2024.12 - 2025.01}
```

PDF 渲染成功，实习经历完整显示！

## 技术总结

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| 实习经历渲染空白 | `title` 字段被错误映射到 `position` | 优先保留 `title/subtitle/date` 原始字段名 |
| 字段覆盖 | 映射逻辑没有区分 internships 和 experience | 分离两种格式的处理逻辑 |

## 关联文件

- `backend/json_normalizer.py` - JSON 标准化器
- `backend/latex_generator.py` - LaTeX 生成器

## 日期

2024-12-07

