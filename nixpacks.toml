# Nixpacks 配置文件 - Railway 构建
# 安装 TeX Live 用于 PDF 渲染（包括 XeLaTeX 和中文支持）

[phases.setup]
nixPkgs = [
  "texlive.combined.scheme-medium",
  "fontconfig"
]
aptPkgs = [
  "texlive-xetex",
  "texlive-fonts-recommended",
  "texlive-fonts-extra",
  "texlive-lang-chinese",
  "fonts-noto-cjk"
]

[phases.install]
# 确保安装所有依赖，添加调试信息
cmds = [
    "echo '=== 安装 Python 依赖 ==='",
    "pwd",
    "ls -la",
    "pip install --upgrade pip",
    "echo '=== 安装根目录依赖 ==='",
    "pip install -r requirements.txt || echo '根目录 requirements.txt 不存在或安装失败'",
    "echo '=== 验证关键依赖安装 ==='",
    "python -c 'import sqlalchemy; print(f\"✅ SQLAlchemy version: {sqlalchemy.__version__}\")' || echo '❌ SQLAlchemy not installed'",
    "python -c 'import pymysql; print(\"✅ PyMySQL installed\")' || echo '❌ PyMySQL not installed'",
    "python -c 'import alembic; print(\"✅ Alembic installed\")' || echo '❌ Alembic not installed'",
    "pip list | grep -E 'sqlalchemy|pymysql|alembic' || echo '依赖验证完成'"
]

# 启动前运行数据库迁移（如果有 DATABASE_URL）
[start]
# 使用启动脚本确保迁移正确执行
cmd = "bash railway-start.sh"
