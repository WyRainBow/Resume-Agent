---
name: 修复历史会话消息格式丢失问题
overview: 修复刷新后加载历史会话时，thought process 和工具输出格式丢失的问题。确保保存和加载时保留消息的结构化信息（thought 字段），以便正确渲染折叠的 Thought Process 组件。
todos:
  - id: backend-message-model
    content: 修改后端 Message 模型，在 backend/agent/schema.py 中添加可选的 thought 字段，并更新 to_dict() 方法
    status: completed
  - id: backend-chat-history-manager
    content: 检查并修改 backend/agent/memory/chat_history_manager.py 的 load_messages() 方法，确保能够从字典创建包含 thought 的 Message 对象
    status: completed
  - id: frontend-save-payload
    content: 修改前端 buildSavePayload 函数（frontend/src/pages/AgentChat/SophiaChat.tsx），保存 thought 字段到后端
    status: completed
  - id: frontend-load-session
    content: 修改前端 loadSession 函数（frontend/src/pages/AgentChat/SophiaChat.tsx），从后端消息中提取并设置 thought 字段
    status: completed
  - id: frontend-auto-load-session
    content: 修改前端 autoLoadSession（在 useEffect 中），同样提取 thought 字段
    status: completed
  - id: backend-history-api
    content: 检查 backend/agent/web/routes/history.py 的 save_session_messages，确保正确处理包含 thought 字段的消息
    status: completed
  - id: test-new-session
    content: 测试创建新会话，发送消息，验证 thought 和 answer 正确显示和保存
    status: completed
  - id: test-load-session
    content: 测试刷新页面后加载历史会话，验证 thought 仍然可以折叠显示
    status: completed
  - id: test-backward-compatibility
    content: 测试旧会话（没有 thought 字段）是否仍然正常显示
    status: completed
---

# 修复历史

会话消息格式丢失问题

## 问题分析

当前问题：

1. **实时流式输出时**：前端通过 SSE 接收 `thought` 和 `answer` 事件，使用 `ThoughtProcess` 组件正确渲染，支持折叠
2. **保存消息时**：前端 `buildSavePayload` 只保存 `role` 和 `content`，丢弃了 `thought` 字段
3. **后端存储**：后端 `Message` 模型没有 `thought` 字段，无法存储思考过程
4. **加载消息时**：从后端加载的消息只有 `content`，没有 `thought`，导致无法使用 `ThoughtProcess` 组件，只能显示纯文本

## 解决方案

### 1. 修改后端 Message 模型

**文件**: `backend/agent/schema.py`

- 在 `Message` 类中添加可选的 `thought` 字段
- 更新 `to_dict()` 方法，包含 `thought` 字段
```python
class Message(BaseModel):
    role: ROLE_TYPE = Field(...)
    content: Optional[str] = Field(default=None)
    thought: Optional[str] = Field(default=None)  # 新增
    tool_calls: Optional[List[ToolCall]] = Field(default=None)
    # ... 其他字段
    
    def to_dict(self) -> dict:
        message = {"role": self.role}
        if self.content is not None:
            message["content"] = self.content
        if self.thought is not None:  # 新增
            message["thought"] = self.thought
        # ... 其他字段
```




### 2. 修改前端保存逻辑

**文件**: `frontend/src/pages/AgentChat/SophiaChat.tsx`

- 修改 `buildSavePayload` 函数，保存 `thought` 字段
```typescript
const buildSavePayload = useCallback((messagesToSave: Message[]) => {
  return messagesToSave.map((msg) => ({
    role: msg.role,
    content: msg.content,
    thought: msg.thought,  // 新增：保存 thought 字段
  }));
}, []);
```




### 3. 修改前端加载逻辑

**文件**: `frontend/src/pages/AgentChat/SophiaChat.tsx`

- 修改 `loadSession` 函数，从后端消息中提取 `thought` 字段
- 修改 `autoLoadSession` 函数（在 `useEffect` 中），同样提取 `thought` 字段
```typescript
const loadedMessages: Message[] = userVisibleMessages.map((m: any, index: number) => ({
  id: generateMessageId(m.content || '', m.role || 'unknown', index),
  role: m.role === 'user' ? 'user' : 'assistant',
  content: m.content || '',
  thought: m.thought || undefined,  // 新增：加载 thought 字段
  timestamp: new Date().toISOString(),
}));
```




### 4. 修改后端保存逻辑（如果需要）

**文件**: `backend/agent/web/routes/history.py`

- 确保 `save_session_messages` 正确处理包含 `thought` 字段的消息
- `ChatHistoryManager.load_messages()` 应该能够处理 `thought` 字段

**文件**: `backend/agent/memory/chat_history_manager.py`

- 检查 `load_messages()` 方法，确保能够从字典创建包含 `thought` 的 `Message` 对象

### 5. 向后兼容处理

- 对于没有 `thought` 字段的旧消息，前端应该能够正常显示（只显示 `content`）
- `ChatMessage` 组件已经支持 `thought` 可选，无需修改

## 数据流

```javascript
实时流式输出:
  SSE (thought) → 前端 state (thought) → ChatMessage (ThoughtProcess 组件)
  SSE (answer) → 前端 state (content) → ChatMessage (Response 内容)

保存:
  前端 Message {thought, content} → buildSavePayload → 后端 API → 后端 Message {thought, content} → 文件存储

加载:
  文件存储 → 后端 Message {thought, content} → 后端 API → 前端 Message {thought, content} → ChatMessage (ThoughtProcess + Response)
```



## 测试要点

1. 创建新会话，发送消息，验证 thought 和 answer 正确显示
2. 刷新页面，加载历史会话，验证 thought 仍然可以折叠显示