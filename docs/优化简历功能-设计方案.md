# 优化简历功能 - 设计方案

## 功能概述

为已创建简历的用户提供智能优化服务，通过对话式引导帮助用户完善简历内容。

---

## UI 设计

### 1. 侧边栏入口

**位置**：左侧导航栏

**按钮设计**：
```tsx
// components/Sidebar.tsx
<MenuItem
  icon={SparklesIcon}
  label="优化简历"
  path="/resume/optimize/:resumeId"
  description="AI 智能诊断和优化"
/>
```

**触发条件**：
- 用户已有简历
- 点击"优化简历"按钮

---

### 2. 优化页面布局

```
┌─────────────────────────────────────────────────────────┐
│  优化简历 - {简历名称}                                    │
├──────────────────────┬──────────────────────────────────┤
│                      │                                  │
│   💬 对话区域          │      📄 简历预览                  │
│   (左侧 40%)          │      (右侧 60%)                  │
│                      │                                  │
│  ┌─────────────────┐ │  ┌──────────────────────────┐  │
│  │ AI: 收到！让我   │ │  │                          │  │
│  │ 先看看您的简历  │ │  │   {简历预览内容}          │  │
│  │                 │ │  │                          │  │
│  │ 用户：帮我看看   │ │  │   - 基本信息             │  │
│  │ 我的简历怎么样  │ │  │   - 个人总结             │  │
│  │                 │ │  │   - 工作经历             │  │
│  │ AI: 好的，我已  │ │  │   - 项目经历             │  │
│  │ 经仔细阅读...   │ │  │   - 教育背景             │  │
│  │                 │ │  │   - 技能                 │  │
│  │ [诊断报告卡片]  │ │  │                          │  │
│  │                 │ │  └──────────────────────────┘  │
│  │ [引导选项卡片]  │ │                                  │
│  │                 │ │                                  │
│  └─────────────────┘ │                                  │
│                      │                                  │
│   [输入框]            │                                  │
│                      │                                  │
└──────────────────────┴──────────────────────────────────┘
```

---

### 3. 对话区域设计

**消息类型**：

1. **AI 消息**
   - 普通文本
   - 诊断报告卡片
   - 引导选项卡片（选择题）
   - 追问消息

2. **用户消息**
   - 用户输入文本
   - 用户选择的选项

**诊断报告卡片**：
```tsx
<DiagnosisReportCard>
  <Header>
    <Icon>📊</Icon>
    <Title>简历诊断报告</Title>
    <Score>45分</Score>
  </Header>

  <Content>
    <OverallStatus>
      "这份简历还比较'骨感'，需要我们一起把它充实起来！"
    </OverallStatus>

    <IssueList>
      <Issue level="critical">
        ❌ 个人总结缺失
        <Description>这是HR看简历的第一眼，建议优先填写</Description>
      </Issue>

      <Issue level="high">
        ⚠️ 工作经历缺少量化数据
        <Description>建议添加具体的数字、百分比或成果</Description>
      </Issue>
    </IssueList>

    <OptimizationPath>
      <h4>建议的优化路径：</h4>
      <Steps>
        <Step>1. 完善个人总结</Step>
        <Step>2. 优化工作经历（添加量化数据）</Step>
        <Step>3. 完善项目经历</Step>
      </Steps>
    </OptimizationPath>
  </Content>
</DiagnosisReportCard>
```

**引导选项卡片**：
```tsx
<GuidanceChoicesCard>
  <Title>您想从哪个方面开始优化？</Title>

  <Choices>
    <Choice
      id="optimize_summary"
      priority="high"
      onClick={() => handleChoice('summary')}
    >
      <Icon>📝</Icon>
      <Text>个人总结：先写好简历的"开场白"</Text>
      <Reason>这是HR看简历的第一眼</Reason>
    </Choice>

    <Choice
      id="optimize_experience"
      priority="high"
      onClick={() => handleChoice('experience')}
    >
      <Icon>💼</Icon>
      <Text>工作经历：填充您的实战经验</Text>
      <Reason>展示核心竞争力</Reason>
    </Choice>

    <Choice
      id="auto_optimize"
      priority="high"
      onClick={() => handleChoice('auto')}
    >
      <Icon>✨</Icon>
      <Text>按照我的专业建议，从最重要的模块开始</Text>
      <Reason>系统性的优化一遍</Reason>
    </Choice>
  </Choices>
</GuidanceChoicesCard>
```

**追问消息**：
```tsx
<FollowUpMessage>
  <Content>
    {user_input}

    💡 **为了让HR更直观地看到您的价值，建议补充一些量化数据：**

    这个成果大概达到了什么程度？比如：
    - 提升了 20%-30% 的效率？
    - 降低了多少成本？
    - 处理了多少并发请求？
  </Content>
</FollowUpMessage>
```

---

### 4. 简历预览区域

**功能**：
- 实时显示简历内容
- 当 AI 更新简历时自动刷新
- 高亮当前正在优化的模块

**实现**：
```tsx
<ResumePreview>
  <ResumeContent resumeData={resumeData}>
    <BasicInfoSection />
    <SummarySection highlight={currentModule === 'summary'} />
    <ExperienceSection highlight={currentModule === 'experience'} />
    <ProjectsSection highlight={currentModule === 'projects'} />
    <EducationSection highlight={currentModule === 'education'} />
    <SkillsSection highlight={currentModule === 'skills'} />
  </ResumeContent>
</ResumePreview>
```

---

## 后端实现

### 1. API 路由

```python
# backend/api/resume_optimization.py

from fastapi import APIRouter, Depends
from backend.agents.diagnosis import ResumeDiagnosis, GuidanceEngine, FollowUpSystem

router = APIRouter(prefix="/api/resume-optimization", tags=["简历优化"])

@router.post("/diagnose")
async def diagnose_resume(resume_id: str):
    """诊断简历"""
    # 1. 读取简历数据
    resume_data = await get_resume_data(resume_id)

    # 2. 执行诊断
    diagnosis = ResumeDiagnosis()
    report = diagnosis.diagnose(resume_data)

    # 3. 生成引导消息和选项
    guidance = GuidanceEngine()
    message = guidance.generate_diagnosis_message(report)
    choices = guidance.generate_guidance_choices(report)

    return {
        "report": report.to_dict(),
        "message": message,
        "choices": choices
    }

@router.post("/chat")
async def chat_optimize(request: ChatRequest):
    """处理优化对话"""
    resume_id = request.resume_id
    user_message = request.message
    session_id = request.session_id

    # 使用 CVAgent 处理对话
    # CVAgent 内部会调用诊断系统、引导引擎、追问系统等

    agent = ResumeOptimizationAgent(
        resume_id=resume_id,
        session_id=session_id
    )

    response = await agent.chat(user_message)

    return response
```

---

### 2. ResumeOptimizationAgent

```python
# backend/agents/resume_optimization_agent.py

from typing import Generator, Dict, Any
from .cv_agent import CVAgent
from .diagnosis import ResumeDiagnosis, GuidanceEngine, FollowUpSystem

class ResumeOptimizationAgent(CVAgent):
    """简历优化专用 Agent"""

    def __init__(self, resume_id: str, session_id: str):
        super().__init__(resume_data=None, session_id=session_id)
        self.resume_id = resume_id

        # 初始化诊断系统
        self.diagnosis = ResumeDiagnosis()
        self.guidance = GuidanceEngine()
        self.followup = FollowUpSystem()

        # 状态
        self.current_module = None
        self.is_followup_mode = False

    def process_message_stream(self, user_message: str) -> Generator[Dict[str, Any], None, None]:
        """处理用户消息"""

        # 加载简历数据
        resume_data = self._load_resume_data()

        # 检测用户意图
        intent = self._detect_intent(user_message)

        if intent == "diagnose":
            # 诊断意图：执行诊断
            yield from self._handle_diagnose(resume_data)

        elif intent == "optimize_module":
            # 优化模块意图
            module = self._extract_module(user_message)
            yield from self._handle_optimize_module(module, resume_data)

        elif intent == "provide_info":
            # 提供信息意图：可能是追问模式
            if self.is_followup_mode:
                yield from self._handle_followup(user_message, resume_data)
            else:
                # 使用父类的常规处理
                yield from super().process_message_stream(user_message)

        else:
            # 其他意图：使用父类处理
            yield from super().process_message_stream(user_message)

    def _handle_diagnose(self, resume_data: Dict):
        """处理诊断意图"""

        # 1. 发送"正在诊断"消息
        yield {
            "type": "text",
            "content": "收到！让我先看看您的简历。",
            "role": "assistant"
        }

        # 2. 执行诊断
        report = self.diagnosis.diagnose(resume_data)

        # 3. 发送诊断报告
        yield {
            "type": "diagnosis_report",
            "content": report.to_dict(),
            "message": report.to_message(),
            "role": "assistant"
        }

        # 4. 发送引导选项
        choices = self.guidance.generate_guidance_choices(report)
        yield {
            "type": "guidance_choices",
            "choices": choices,
            "message": "您想从哪个方面开始优化？",
            "role": "assistant"
        }

    def _handle_optimize_module(self, module: str, resume_data: Dict):
        """处理模块优化意图"""

        self.current_module = module

        # 生成模块引导问题
        question = self.guidance.generate_module_question(module, resume_data)

        yield {
            "type": "text",
            "content": question,
            "role": "assistant"
        }

        # 进入追问模式
        self.is_followup_mode = True

    def _handle_followup(self, user_message: str, resume_data: Dict):
        """处理追问模式"""

        # 开始或继续追问
        if not hasattr(self.followup, 'collected_info'):
            # 第一次追问
            followup_question = self.followup.start_followup(
                self.current_module,
                user_message
            )
        else:
            # 继续追问
            followup_question = self.followup.continue_followup(
                user_message,
                {"resume_data": resume_data}
            )

        if followup_question:
            # 还有追问
            yield {
                "type": "followup",
                "content": followup_question,
                "role": "assistant"
            }
        else:
            # 追问完成，生成最终内容
            yield from self._generate_and_update(user_message, resume_data)

    def _detect_intent(self, message: str) -> str:
        """检测用户意图"""

        diagnosis_keywords = ["帮我看看", "诊断", "怎么样", "有什么建议", "优化简历"]
        module_keywords = ["个人总结", "工作经历", "项目经历", "教育经历", "技能"]

        if any(word in message for word in diagnosis_keywords):
            return "diagnose"

        if any(word in message for word in module_keywords):
            return "optimize_module"

        return "provide_info"

    def _extract_module(self, message: str) -> str:
        """从消息中提取模块名"""

        if "个人总结" in message or "总结" in message:
            return "summary"
        elif "工作经历" in message or "实习" in message:
            return "experience"
        elif "项目经历" in message or "项目" in message:
            return "projects"
        elif "教育经历" in message or "教育" in message:
            return "education"
        elif "技能" in message:
            return "skills"

        return "unknown"
```

---

## 前端实现

### 1. 路由

```tsx
// App.tsx
<Route path="/resume/optimize/:resumeId" element={<ResumeOptimizationPage />} />
```

### 2. 页面组件

```tsx
// pages/ResumeOptimizationPage.tsx

import { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { ChatPanel } from '@/components/ChatPanel';
import { ResumePreview } from '@/components/ResumePreview';
import { DiagnosisReportCard } from '@/components/DiagnosisReportCard';
import { GuidanceChoicesCard } from '@/components/GuidanceChoicesCard';

export function ResumeOptimizationPage() {
  const { resumeId } = useParams();
  const [messages, setMessages] = useState([]);
  const [resumeData, setResumeData] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);

  useEffect(() => {
    // 页面加载时自动触发诊断
    handleDiagnose();
  }, [resumeId]);

  const handleDiagnose = async () => {
    setIsProcessing(true);

    try {
      const response = await fetch('/api/resume-optimization/diagnose', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ resume_id: resumeId })
      });

      const data = await response.json();

      // 添加诊断报告消息
      setMessages([
        {
          type: 'text',
          content: '收到！让我先看看您的简历。',
          role: 'assistant'
        },
        {
          type: 'diagnosis_report',
          ...data.report,
          message: data.message,
          role: 'assistant'
        },
        {
          type: 'guidance_choices',
          choices: data.choices,
          message: '您想从哪个方面开始优化？',
          role: 'assistant'
        }
      ]);

    } catch (error) {
      console.error('诊断失败:', error);
    } finally {
      setIsProcessing(false);
    }
  };

  const handleSendMessage = async (message: string) => {
    // 添加用户消息
    setMessages(prev => [...prev, {
      type: 'text',
      content: message,
      role: 'user'
    }]);

    setIsProcessing(true);

    try {
      const response = await fetch('/api/resume-optimization/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          resume_id: resumeId,
          message: message,
          session_id: getSessionId()
        })
      });

      const stream = response.body;
      const reader = stream.getReader();

      // 处理流式响应...

    } catch (error) {
      console.error('发送消息失败:', error);
    } finally {
      setIsProcessing(false);
    }
  };

  const handleChoiceClick = async (choice: any) => {
    // 用户点击了引导选项
    handleSendMessage(choice.text);
  };

  return (
    <div className="resume-optimization-page">
      <div className="chat-panel">
        <ChatPanel
          messages={messages}
          onSendMessage={handleSendMessage}
          isProcessing={isProcessing}
          renderMessage={(message) => {
            if (message.type === 'diagnosis_report') {
              return <DiagnosisReportCard data={message} />;
            }
            if (message.type === 'guidance_choices') {
              return (
                <GuidanceChoicesCard
                  choices={message.choices}
                  onChoiceClick={handleChoiceClick}
                />
              );
            }
            return null;
          }}
        />
      </div>

      <div className="resume-preview">
        <ResumePreview
          resumeData={resumeData}
          highlightModule={currentModule}
        />
      </div>
    </div>
  );
}
```

---

## 数据流

```
用户点击"优化简历"
    ↓
进入 /resume/optimize/:resumeId
    ↓
自动触发诊断 API
    ↓
后端执行诊断 → 返回报告和选项
    ↓
前端显示诊断报告卡片
    ↓
用户点击选项或输入文字
    ↓
发送消息到 chat API
    ↓
后端 ResumeOptimizationAgent 处理：
  - 检测意图
  - 调用诊断/引导/追问系统
  - 可能调用 CVEditor 更新简历
    ↓
前端接收流式响应
    ↓
更新对话区域
    ↓
更新简历预览（如果有变化）
```

---

## 实施优先级

### 第一阶段：基础功能（1-2天）
- ✅ 创建侧边栏入口
- ✅ 创建优化页面布局（左右分栏）
- ✅ 实现诊断 API
- ✅ 实现基础对话功能
- ✅ 显示诊断报告卡片

### 第二阶段：核心功能（2-3天）
- ⏳ 实现引导选项卡片
- ⏳ 实现追问功能
- ⏳ 集成 CVEditor 实时更新简历
- ⏳ 简历预览实时刷新
- ⏳ 高亮当前优化模块

### 第三阶段：优化体验（1-2天）
- ⏳ 添加加载动画
- ⏳ 优化错误处理
- ⏳ 添加重试机制
- ⏳ 优化移动端适配
- ⏳ 添加使用引导

---

## 关键文件

### 后端
- `backend/api/resume_optimization.py` - API 路由
- `backend/agents/resume_optimization_agent.py` - 优化 Agent
- `backend/agents/diagnosis/` - 诊断系统（已实现）

### 前端
- `pages/ResumeOptimizationPage.tsx` - 优化页面
- `components/ChatPanel.tsx` - 对话面板
- `components/ResumePreview.tsx` - 简历预览
- `components/DiagnosisReportCard.tsx` - 诊断报告卡片
- `components/GuidanceChoicesCard.tsx` - 引导选项卡片
- `components/Sidebar.tsx` - 侧边栏（添加入口）

---

## 下一步

1. **创建 ResumeOptimizationAgent**（集成诊断系统）
2. **实现前端页面和组件**
3. **连接前后端**
4. **测试完整流程**
