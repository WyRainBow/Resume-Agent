# 简历诊断引导系统 - 架构设计

## 📋 需求概述

参考优秀 AI 简历助手的对话引导机制，实现一套完整的简历诊断和引导系统。

### 核心功能
1. **简历诊断**：自动分析简历的完整性、内容质量、结构格式、匹配度
2. **智能引导**：根据诊断结果，引导用户优先优化核心模块
3. **渐进式追问**：使用 STAR 法则逐步引导用户提供详细信息
4. **平衡引导**：在主动引导和尊重用户选择之间找到平衡

---

## 🏗️ 系统架构

### 1. 核心组件

```
┌─────────────────────────────────────────────────┐
│              CVAgent (主入口)                     │
│  - 处理用户消息                                   │
│  - 调用诊断系统                                   │
│  - 执行引导策略                                   │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│         ResumeDiagnosis (简历诊断器)              │
│  - 完整性检查                                     │
│  - 内容质量评估                                   │
│  - 结构格式分析                                   │
│  - 匹配度计算                                     │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│       GuidanceEngine (引导策略引擎)               │
│  - 优先级决策                                     │
│  - 引导路径规划                                   │
│  - 话术生成                                       │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│      FollowUpSystem (渐进式追问系统)              │
│  - STAR 法则引导                                  │
│  - 量化数据追问                                   │
│  - 示例提供                                       │
│  - 占位符处理                                     │
└─────────────────────────────────────────────────┘
```

---

## 📊 详细设计

### 一、简历诊断器（ResumeDiagnosis）

#### 1.1 诊断维度

**维度 1：完整性（Completeness）**
```python
 completeness_checks = {
     "basic": ["name", "email", "phone", "headline"],
     "summary": ["content"],
     "experience": ["company", "position", "date", "summary"],
     "projects": ["name", "description", "techStack"],
     "education": ["school", "major", "date"],
     "skills": ["keywords"]
 }
```

**检查项：**
- 必填字段是否缺失
- 字段内容是否为空
- 数组字段是否至少有一条记录

**输出：**
```python
{
    "dimension": "completeness",
    "score": 0.6,  # 0-1 分数
    "issues": [
        {"field": "sections.summary.content", "issue": "missing", "severity": "high"},
        {"field": "sections.experience", "issue": "empty", "severity": "high"}
    ]
}
```

---

**维度 2：内容质量（Content Quality）**
```python
quality_checks = {
    "quantifiable_data": {
        "description": "工作/项目经历中是否包含量化数据",
        "pattern": r"\d+%|\d+倍|\d+次|提升.*\d+|降低.*\d+",
        "fields": ["experience", "projects"]
    },
    "star_method": {
        "description": "描述是否体现 STAR 法则",
        "min_length": 50,  # 最小字符数
        "keywords": ["负责", "参与", "优化", "实现", "开发"],
        "fields": ["experience", "projects"]
    },
    "keyword_matching": {
        "description": "是否包含目标岗位相关关键词",
        "target_field": "basic.headline",
        "check_fields": ["experience", "projects", "skills"]
    },
    "vague_words": {
        "description": "是否存在大量空泛词汇",
        "vague_words": ["负责", "参与", "熟悉", "了解"],
        "threshold": 0.5  # 空泛词汇占比阈值
    }
}
```

**输出：**
```python
{
    "dimension": "content_quality",
    "score": 0.4,
    "issues": [
        {
            "field": "sections.experience.items[0].summary",
            "issue": "lack_quantifiable_data",
            "severity": "high",
            "suggestion": "缺少量化数据，建议添加具体的数字、百分比或成果"
        },
        {
            "field": "sections.experience.items[0].summary",
            "issue": "too_vague",
            "severity": "medium",
            "suggestion": "描述过于空泛，建议使用 STAR 法则详细描述"
        }
    ]
}
```

---

**维度 3：结构与格式（Structure & Format）**
```python
structure_checks = {
    "timeline_consistency": {
        "description": "时间线一致性检查",
        "check_overlap": True,
        "check_gaps": True
    },
    "html_format": {
        "description": "富文本字段 HTML 格式检查",
        "fields": ["summary.content", "experience.summary", "projects.description"]
    },
    "length_check": {
        "description": "内容长度检查",
        "min_length": {"summary": 100, "experience": 50},
        "max_length": {"summary": 500, "experience": 1000}
    }
}
```

---

**维度 4：匹配度（Relevance）**
```python
relevance_checks = {
    "position_matching": {
        "description": "内容是否与目标岗位匹配",
        "target_field": "basic.headline"
    },
    "skills_matching": {
        "description": "技能是否与目标岗位要求相符"
    }
}
```

---

#### 1.2 诊断报告生成

```python
@dataclass
class DiagnosisReport:
    """诊断报告"""
    overall_score: float  # 总体分数 0-1
    dimensions: Dict[str, DimensionResult]  # 各维度结果
    priority_issues: List[Issue]  # 优先级问题列表（top 3-5）
    optimization_path: List[str]  # 优化路径建议

    def to_message(self) -> str:
        """转换为用户友好的消息"""
        pass
```

**输出示例：**
```python
{
    "overall_score": 0.45,
    "diagnosis_level": "needs_major_improvement",
    "dimensions": {
        "completeness": {"score": 0.6, "issues": [...]},
        "content_quality": {"score": 0.3, "issues": [...]},
        "structure": {"score": 0.5, "issues": [...]},
        "relevance": {"score": 0.4, "issues": [...]}
    },
    "priority_issues": [
        {
            "level": "critical",
            "category": "content",
            "description": "个人总结缺失",
            "suggestion": "这是HR看简历的第一眼，建议优先填写"
        },
        {
            "level": "critical",
            "category": "content",
            "description": "工作经历缺少量化数据",
            "suggestion": "添加具体的数字、百分比或成果"
        }
    ],
    "optimization_path": [
        "填写个人总结",
        "优化工作经历（添加量化数据）",
        "完善项目经历",
        "检查时间线一致性"
    ]
}
```

---

### 二、引导策略引擎（GuidanceEngine）

#### 2.1 优先级决策

```python
class PriorityDecision(Enum):
    """优先级决策"""
    CRITICAL = "critical"  # 关键问题，必须立即处理
    HIGH = "high"  # 高优先级
    MEDIUM = "medium"  # 中优先级
    LOW = "low"  # 低优先级

# 模块优先级映射
MODULE_PRIORITY = {
    "summary": 1,  # 个人总结 - 最高优先级
    "experience": 2,  # 工作经历
    "projects": 3,  # 项目经历
    "education": 4,  # 教育经历
    "skills": 5,  # 技能
    "basic": 6  # 基本信息 - 通常已填写
}
```

**决策逻辑：**
1. **核心模块优先**：个人总结 > 工作经历 > 项目经历
2. **问题最严重的优先**：完全空白 > 内容空洞 > 格式问题
3. **用户意图优先**：如果用户明确指定，尊重用户选择

---

#### 2.2 引导话术生成

```python
class GuidanceMessageGenerator:
    """引导消息生成器"""

    def generate_diagnosis_message(self, report: DiagnosisReport) -> str:
        """生成诊断消息"""
        pass

    def generate_guidance_choices(self, report: DiagnosisReport) -> List[Dict]:
        """生成引导选项"""
        return [
            {
                "id": "optimize_summary",
                "text": "个人总结：先写好简历的\"开场白\"",
                "priority": "high",
                "reason": "这是HR看简历的第一眼"
            },
            {
                "id": "optimize_experience",
                "text": "工作经历：填充您的实战经验",
                "priority": "high",
                "reason": "展示核心竞争力"
            }
        ]

    def generate_module_question(self, module: str) -> str:
        """生成模块引导问题"""
        questions = {
            "summary": """
                为了写出贴合您实际情况的个人总结，我需要了解几个关键信息：

                1. 您的目标岗位是？
                2. 您最擅长的技术/技能是？（请列举2-3个）
                3. 您最满意的成就是？（1-2个亮点）

                请告诉我这些信息，我来帮您生成一个初步的个人总结。
            """,
            "experience": """
                为了充实您的工作经历，我需要了解：

                1. 公司名称和职位？
                2. 工作时间？
                3. 主要职责是什么？
                4. 取得了什么成果？（请尽量具体）

                我们可以一段一段来，您先告诉我第一份工作经历。
            """
        }
        return questions.get(module, "")
```

---

### 三、渐进式追问系统（FollowUpSystem）

#### 3.1 STAR 法则引导

```python
class STARFollowUp:
    """STAR 法则追问"""

    def __init__(self):
        self.current_step = "S"  # 当前追问步骤
        self.collected_info = {}  # 已收集的信息

    def generate_followup_question(self, user_input: str, context: Dict) -> str:
        """生成追问问题"""
        pass

    def check_completeness(self, info: Dict) -> bool:
        """检查信息是否完整"""
        required_fields = ["situation", "task", "action", "result"]
        return all(field in info for field in required_fields)
```

**追问策略：**
```python
FOLLOWUP_TEMPLATES = {
    "quantification": """
        {previous_input}

        为了让HR更直观地看到您的价值，我建议补充一些量化数据。

        这个成果大概达到了什么程度？比如：
        - 提升了 20%-30% 的效率？
        - 降低了多少成本？
        - 处理了多少并发请求？
        - 如果不记得精确数字，给我一个大概感觉也行。
    """,

    "specific_action": """
        您提到{action}，能否具体说明：

        1. 您是如何实现的？
        2. 使用了哪些技术或方法？
        3. 遇到了什么挑战？是如何解决的？

        这样可以让您的经历更加具体可信。
    """,

    "star_framework": """
        我们可以用 STAR 法则来充实这段经历：

        📌 **Situation（情境）**：当时的项目背景是什么？
        📌 **Task（任务）**：您负责什么任务？
        📌 **Action（行动）**：您具体做了什么？
        📌 **Result（结果）**：取得了什么成果？

        您先告诉我**情境**和**任务**，我们一步步来。
    """
}
```

---

#### 3.2 信息提取与结构化

```python
class InformationExtractor:
    """信息提取器"""

    def extract_experience_info(self, user_input: str) -> Dict:
        """从用户输入中提取工作经历信息"""
        return {
            "company": extract_company(user_input),
            "position": extract_position(user_input),
            "date": extract_date(user_input),
            "summary": user_input,
            "quantifiable_data": check_quantifiable(user_input),
            "completeness": calculate_completeness(user_input)
        }

    def identify_gaps(self, extracted_info: Dict) -> List[str]:
        """识别信息缺口"""
        gaps = []
        if not extracted_info.get("quantifiable_data"):
            gaps.append("quantifiable_data")
        if extracted_info.get("completeness") < 0.5:
            gaps.append("detail")
        return gaps
```

---

### 四、平衡引导机制

```python
class BalanceGuidance:
    """平衡引导策略"""

    ALWAYS_GIVE_EXIT_OPTION = True  # 始终提供退出选项
    EXPLAIN_WHY = True  # 解释为什么
    USER_CONTROL_PRIORITY = True  # 用户控制权优先
    PROGRESSIVE_GUIDANCE = True  # 渐进式引导

    def generate_guidance_with_exit(self, message: str) -> Dict:
        """生成带退出选项的引导"""
        return {
            "type": "guidance",
            "content": message,
            "options": [
                {"text": "好的，开始优化", "action": "accept"},
                {"text": "先跳过，看看其他部分", "action": "skip"}
            ]
        }

    def explain_why(self, suggestion: str, reason: str) -> str:
        """解释为什么"""
        return f"""
        {suggestion}

        💡 **为什么要这样做？**
        {reason}

        这样可以让您的简历更具竞争力。
        """
```

---

## 🔄 完整流程

### 用户首次创建简历流程

```
1. 用户："帮我看看我的简历怎么样？"
   ↓
2. CVAgent 调用 ResumeDiagnosis
   ↓
3. 诊断器分析 4 个维度，生成报告
   ↓
4. GuidanceEngine 生成诊断消息和选项
   ↓
5. AI 展示诊断结果和优化路径
   ↓
6. 用户选择优化模块
   ↓
7. FollowUpSystem 开始引导
   ↓
8. 渐进式追问（STAR 法则）
   ↓
9. 生成预览，用户确认
   ↓
10. 调用 CVEditor 更新简历
   ↓
11. 继续下一个模块
```

---

## 📁 文件结构

```
backend/agents/
├── diagnosis/
│   ├── __init__.py
│   ├── resume_diagnosis.py      # 简历诊断器
│   ├── diagnosis_report.py      # 诊断报告
│   ├── guidance_engine.py       # 引导策略引擎
│   └── followup_system.py       # 渐进式追问系统
├── cv_agent.py                  # 修改：集成诊断系统
```

---

## 🎯 实施步骤

1. ✅ 创建 feature 分支
2. ⏳ 实现简历诊断器（ResumeDiagnosis）
3. ⏳ 实现诊断报告（DiagnosisReport）
4. ⏳ 实现引导策略引擎（GuidanceEngine）
5. ⏳ 实现渐进式追问系统（FollowUpSystem）
6. ⏳ 集成到 CVAgent
7. ⏳ 测试完整流程

---

## 🔑 关键设计原则

1. **非侵入式**：不破坏现有 CVAgent 架构
2. **模块化**：各组件独立，易于测试和维护
3. **可配置**：诊断维度、引导策略可配置
4. **用户友好**：始终尊重用户选择，提供退出选项
5. **可扩展**：易于添加新的诊断维度和引导策略
