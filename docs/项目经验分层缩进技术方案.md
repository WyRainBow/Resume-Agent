# 项目经验分层缩进技术方案

## 一、需求分析

### 1.1 当前问题

在项目经验的 PDF 渲染中，需要实现分层的缩进效果，存在两种场景：

**场景一：项目描述 + 列表项**
- **第一层缩进（0.8cm）**：项目描述、核心职责与产出等普通文本段落
- **第二层缩进（1.6cm）**：列表项（有序列表 1234、无序列表）

**场景二：专项标题 + 列表项**
- **第一层缩进（0.8cm）**：专项标题（如"搜索服务拆分专项"、"域名黑白名单专项"）
- **第二层缩进（1.6cm）**：专项标题下的无序列表项

### 1.2 目标效果

**场景一示例：**
```
项目名称
  ├─ 项目描述：...（第一层缩进 0.8cm）
  ├─ 核心职责与产出：...（第一层缩进 0.8cm）
  └─ 列表项（第二层缩进 1.6cm）
      ├─ 1. Agent 推理与规划...
      ├─ 2. 多源融合检索架构...
      ├─ 3. RAG 深度阅读...
      └─ 4. 广告数据闭环链路...
```

**场景二示例：**
```
项目名称
  ├─ 搜索服务拆分专项（第一层缩进 0.8cm）
  │   ├─ 针对域名Check查询挤占连接资源...（第二层缩进 1.6cm）
  │   ├─ 按读/写属性垂直拆分EPP服务...（第二层缩进 1.6cm）
  │   └─ 设计公共备用集群作为容灾方案...（第二层缩进 1.6cm）
  ├─ 域名黑白名单专项（第一层缩进 0.8cm）
  │   ├─ 针对域名秒杀抢注、溢价域名交易...（第二层缩进 1.6cm）
  │   ├─ 多级缓存架构：构建"SDK本地缓存..."（第二层缩进 1.6cm）
  │   └─ 数据一致性保障：实现"准实时-增量..."（第二层缩进 1.6cm）
  └─ 风险SQL治理专项（第一层缩进 0.8cm）
      ├─ 优化100余条高风险SQL...（第二层缩进 1.6cm）
      ├─ API优化: 通过强制索引...（第二层缩进 1.6cm）
      ├─ 统计查询优化: 采用代码解耦...（第二层缩进 1.6cm）
      └─ RO迁移: 推动复杂查询向RO...（第二层缩进 1.6cm）
```

## 二、技术方案

### 2.1 内容类型识别

在 `backend/latex_sections.py` 的 `generate_section_projects` 函数中，需要区分 highlights 中的三种内容类型：

1. **普通文本段落**：不包含列表结构（`<ul>`, `<ol>`, `\begin{itemize}`, `\begin{enumerate}`）
   - 例如：项目描述、核心职责与产出
2. **专项标题 + 列表结构**：包含列表，且第一个列表项作为标题（无论是否加粗），后续列表项作为内容
   - 例如：`<ul><li>搜索服务拆分专项</li><li>针对域名Check查询...</li></ul>`
   - 或者：`<ul><li><strong>搜索服务拆分专项</strong></li><li>针对域名Check查询...</li></ul>`
   - **注意**：加粗不是必要条件，完全由用户决定是否加粗
3. **纯列表结构**：包含列表，但不符合专项标题+列表的特征
   - 例如：有序列表 1234、普通无序列表（第一个列表项较长或列表项数量 < 2）

### 2.2 实现策略

#### 方案 A：基于内容检测的分层处理（推荐）

**核心思路**：遍历 highlights 数组，根据内容类型动态选择缩进层级。

**实现步骤**：

1. **初始化三个列表容器**：
   - `paragraph_items`: 存储普通文本段落（第一层缩进 0.8cm）
   - `special_topic_items`: 存储专项标题+列表（标题第一层 0.8cm，列表第二层 1.6cm）
   - `list_items`: 存储纯列表项（第二层缩进 1.6cm）

2. **内容分类逻辑**：
   ```python
   for h in highlights:
       if is_list_content(h):
           if has_special_topic_title(h):  # 检测是否为专项标题+列表
               special_topic_items.append(h)
           else:
               list_items.append(h)
       else:
           paragraph_items.append(h)
   ```

3. **渲染顺序**：
   - 先渲染所有普通文本段落（第一层缩进 0.8cm）
   - 再渲染所有专项标题+列表（标题第一层 0.8cm，列表第二层 1.6cm）
   - 最后渲染所有纯列表项（第二层缩进 1.6cm）

4. **缩进实现方式**：
   - **普通文本段落**：使用 `\begin{itemize}[label={},leftmargin=0.8cm]` 包装
   - **专项标题+列表**：
     - 标题项：使用 `\begin{itemize}[label={},leftmargin=0.8cm]` 包装第一个列表项
       - **重要**：保留原有的加粗格式（如果用户设置了加粗），不强制加粗
       - 例如：如果原内容是 `<strong>搜索服务拆分专项</strong>`，转换为 `\textbf{搜索服务拆分专项}`
       - 如果原内容是 `搜索服务拆分专项`，保持为 `搜索服务拆分专项`
     - 内容项：使用 `\begin{itemize}[label=$\bullet$,leftmargin=1.6cm]` 包装后续列表项
   - **纯列表项**：使用 `\begin{itemize}[leftmargin=1.6cm]` 或 `\begin{enumerate}[leftmargin=1.6cm]` 包装

#### 方案 B：基于索引位置的分层处理

**核心思路**：假设前 N 项是普通文本段落，后续是列表项。

**优点**：实现简单
**缺点**：不够灵活，依赖数据格式固定

**不推荐**：无法适应动态内容结构。

### 2.3 列表检测函数设计

```python
def is_list_content(content: str) -> bool:
    """
    检测内容是否为列表结构
    
    检测规则：
    1. HTML 格式：包含 <ul>、<ol>、<li> 标签
    2. LaTeX 格式：包含 \begin{itemize} 或 \begin{enumerate}
    3. Markdown 格式：以 -、*、+ 或数字开头（需谨慎，避免误判）
    """
    if not isinstance(content, str):
        return False
    
    # HTML 列表检测
    if '<ul>' in content or '<ol>' in content or '<li>' in content:
        return True
    
    # LaTeX 列表检测
    if '\\begin{itemize}' in content or '\\begin{enumerate}' in content:
        return True
    
    return False

def has_special_topic_title(content: str) -> bool:
    """
    检测列表是否包含专项标题（第一个列表项作为标题，后续列表项作为内容）
    
    检测规则（不依赖加粗，完全基于结构）：
    1. 列表必须包含至少 2 个列表项
    2. 第一个列表项作为标题（无论是否加粗）
    3. 后续列表项作为内容
    
    专项标题特征（启发式判断，可选）：
    - 第一个列表项通常较短（如"搜索服务拆分专项"）
    - 第一个列表项可能以"专项"结尾
    - 但加粗不是必要条件，完全由用户决定
    
    实现策略：
    - 如果列表项数量 >= 2，且第一个列表项长度较短（如 < 50 字符），
      则视为专项标题+列表结构
    - 或者更简单的策略：总是将第一个列表项作为标题（如果列表项数量 >= 2）
    """
    if not isinstance(content, str):
        return False
    
    import re
    
    # HTML 格式检测
    if '<ul>' in content or '<ol>' in content:
        # 统计列表项数量
        li_matches = re.findall(r'<li[^>]*>', content)
        if len(li_matches) >= 2:
            # 提取第一个 <li> 标签内容（去除 HTML 标签）
            first_li_match = re.search(r'<li[^>]*>(.*?)</li>', content, re.DOTALL)
            if first_li_match:
                first_li_content = first_li_match.group(1)
                # 去除 HTML 标签，获取纯文本
                text_content = re.sub(r'<[^>]+>', '', first_li_content).strip()
                # 如果第一个列表项较短（启发式：< 50 字符），视为标题
                if len(text_content) < 50:
                    return True
                # 或者如果第一个列表项以"专项"结尾，视为标题
                if text_content.endswith('专项'):
                    return True
                # 或者更宽松的策略：如果列表项数量 >= 2，总是视为专项标题结构
                # return True  # 取消注释以启用此策略
    
    # LaTeX 格式检测
    if '\\begin{itemize}' in content or '\\begin{enumerate}' in content:
        # 统计 \item 数量
        item_matches = re.findall(r'\\item\s+', content)
        if len(item_matches) >= 2:
            # 提取第一个 \item 内容（去除 LaTeX 命令）
            first_item_match = re.search(r'\\item\s+(.*?)(?=\\item|\\end)', content, re.DOTALL)
            if first_item_match:
                first_item_content = first_item_match.group(1)
                # 去除 LaTeX 命令，获取纯文本
                text_content = re.sub(r'\\[a-zA-Z]+\{([^}]*)\}', r'\1', first_item_content)
                text_content = re.sub(r'\\[a-zA-Z]+', '', text_content).strip()
                # 如果第一个列表项较短，视为标题
                if len(text_content) < 50:
                    return True
                # 或者如果第一个列表项以"专项"结尾，视为标题
                if text_content.endswith('专项'):
                    return True
                # 或者更宽松的策略：如果列表项数量 >= 2，总是视为专项标题结构
                # return True  # 取消注释以启用此策略
    
    return False
```

### 2.4 LaTeX 缩进参数配置

#### 第一层缩进（普通文本段落）

```latex
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item 项目描述：...
  \item 核心职责与产出：...
\end{itemize}
```

**参数说明**：
- `label={}`: 无圆点标记（普通段落）
- `leftmargin=0.8cm`: 左侧缩进 0.8cm
- `itemindent=0em`: 项目内容不额外缩进

#### 第二层缩进（列表项）

**无序列表**：
```latex
\begin{itemize}[label=$\bullet$,parsep=0.2ex,leftmargin=1.6cm,labelsep=0.5em]
  \item Agent 推理与规划...
  \item 多源融合检索架构...
\end{itemize}
```

**有序列表**：
```latex
\begin{enumerate}[leftmargin=1.6cm,labelsep=0.5em]
  \item Agent 推理与规划...
  \item 多源融合检索架构...
\end{enumerate}
```

**参数说明**：
- `leftmargin=1.6cm`: 左侧缩进 1.6cm（0.8cm + 0.8cm）
- `label=$\bullet$`: 无序列表使用圆点标记
- `labelsep=0.5em`: 标记与内容之间的间距

### 2.5 代码修改位置

**文件**：`backend/latex_sections.py`

**函数**：`generate_section_projects`

**修改范围**：第 205-333 行（highlights 处理逻辑）

**关键修改点**：

1. **添加辅助函数**（在 `generate_section_projects` 函数之前）：
   ```python
   def is_list_content(content: str) -> bool:
       # 检测是否为列表结构
       ...
   
   def has_special_topic_title(content: str) -> bool:
       # 检测是否为专项标题+列表
       ...
   ```

2. **添加内容分类逻辑**（第 224 行之前）：
   ```python
   # 分类 highlights 内容
   paragraph_items = []
   special_topic_items = []
   list_items = []
   
   for h in highlights:
       if not isinstance(h, str) or not h.strip():
           continue
       if is_list_content(h):
           if has_special_topic_title(h):
               special_topic_items.append(h)
           else:
               list_items.append(h)
       else:
           paragraph_items.append(h)
   ```

3. **分别渲染三类内容**：
   - 先处理 `paragraph_items`（第一层缩进 0.8cm）
   - 再处理 `special_topic_items`（标题第一层 0.8cm，列表第二层 1.6cm）
   - 最后处理 `list_items`（第二层缩进 1.6cm）

4. **专项标题+列表的特殊处理**：
   - 解析列表，提取第一个列表项作为标题（第一层缩进）
   - 将后续列表项作为内容（第二层缩进）

## 三、实现细节

### 3.1 边界情况处理

1. **空 highlights**：直接跳过，不渲染
2. **混合内容**：先渲染所有段落，再渲染专项标题+列表，最后渲染纯列表
3. **嵌套列表**：保持现有嵌套逻辑，仅调整外层 leftmargin
4. **专项标题检测失败**：如果专项标题检测不准确，可能误判为纯列表，需要优化检测逻辑
5. **专项标题只有一个列表项**：如果专项标题后没有内容项，只渲染标题（第一层缩进）
6. **专项标题格式保留**：无论标题是否加粗，系统都会保留原有的格式（加粗或非加粗）
7. **专项标题不在第一个位置**：如果标题不在第一个列表项位置，按纯列表处理（第二层缩进）

### 3.2 兼容性考虑

1. **向后兼容**：如果 highlights 中只有列表或只有段落，仍能正常渲染
2. **格式兼容**：支持 HTML、Markdown、纯文本三种格式
3. **现有功能**：不影响 items 子项目结构的渲染

### 3.3 性能影响

- **时间复杂度**：O(n)，n 为 highlights 数量
- **空间复杂度**：O(n)，需要临时存储分类结果
- **影响范围**：仅影响项目经验的 PDF 渲染，不影响前端显示

## 四、测试用例

### 4.1 测试数据

**场景一：项目描述 + 列表项**
```json
{
  "projects": [
    {
      "title": "深言科技-语鲸 DeepResearch-AI Agent 智能搜索系统新项目",
      "highlights": [
        "项目描述：基于清华大模型构建的自主式深度研究（DeepResearch）智能体...",
        "核心职责与产出：参与 AI 搜索链路并主导广告投放系统开发...",
        "<ol><li>Agent 推理与规划...</li><li>多源融合检索架构...</li></ol>"
      ]
    }
  ]
}
```

**场景二：专项标题 + 列表项（加粗版本）**
```json
{
  "projects": [
    {
      "title": "腾讯云域名注册业务",
      "highlights": [
        "<ul><li><strong>搜索服务拆分专项</strong></li><li>针对域名Check查询挤占连接资源导致核心业务超时问题、主导服务架构拆分。</li><li>按读/写属性垂直拆分EPP服务为读写两个独立集群、配置物理隔离连接池</li><li>设计公共备用集群作为容灾方案。增加命令路由切换、根据命令类型分发至对应集群、实现故障隔离</li></ul>",
        "<ul><li><strong>域名黑白名单专项</strong></li><li>针对域名秒杀抢注、溢价域名交易、恶意API攻击等核心业务场景、从0到1实现了域名黑白名单模块，提供统一的名单管控</li><li>多级缓存架构：构建\"SDK本地缓存 + Redis分布式缓存\"架构、通过Guava Cache和5秒过期策略，支撑近万QPS峰值、本地缓存命中率97%以上</li><li>数据一致性保障：实现\"准实时-增量-全量\"多重保障、通过写DB+发MQ、Binlog监听、定时任务确保数据一致性</li></ul>",
        "<ul><li><strong>风险SQL治理专项</strong></li><li>优化100余条高风险SQL、扫描行数从超百万行降至万行以下、执行时间提升80%。</li><li>API优化: 通过强制索引、JOIN优化等手段、确保查询毫秒级响应</li><li>统计查询优化: 采用代码解耦、游标分页处理大数据量查询</li><li>RO迁移: 推动复杂查询向RO只读实例迁移、降低主库负载</li></ul>"
      ]
    }
  ]
}
```

**场景二：专项标题 + 列表项（不加粗版本）**
```json
{
  "projects": [
    {
      "title": "腾讯云域名注册业务",
      "highlights": [
        "<ul><li>搜索服务拆分专项</li><li>针对域名Check查询挤占连接资源导致核心业务超时问题、主导服务架构拆分。</li><li>按读/写属性垂直拆分EPP服务为读写两个独立集群、配置物理隔离连接池</li><li>设计公共备用集群作为容灾方案。增加命令路由切换、根据命令类型分发至对应集群、实现故障隔离</li></ul>",
        "<ul><li>域名黑白名单专项</li><li>针对域名秒杀抢注、溢价域名交易、恶意API攻击等核心业务场景、从0到1实现了域名黑白名单模块，提供统一的名单管控</li><li>多级缓存架构：构建\"SDK本地缓存 + Redis分布式缓存\"架构、通过Guava Cache和5秒过期策略，支撑近万QPS峰值、本地缓存命中率97%以上</li><li>数据一致性保障：实现\"准实时-增量-全量\"多重保障、通过写DB+发MQ、Binlog监听、定时任务确保数据一致性</li></ul>",
        "<ul><li>风险SQL治理专项</li><li>优化100余条高风险SQL、扫描行数从超百万行降至万行以下、执行时间提升80%。</li><li>API优化: 通过强制索引、JOIN优化等手段、确保查询毫秒级响应</li><li>统计查询优化: 采用代码解耦、游标分页处理大数据量查询</li><li>RO迁移: 推动复杂查询向RO只读实例迁移、降低主库负载</li></ul>"
      ]
    }
  ]
}
```

**说明**：专项标题是否加粗完全由用户决定，系统会保留原有的加粗格式（如果有的话），不会强制加粗或去除加粗。

### 4.2 预期输出

**场景一输出：**
```latex
\datedsubsection{\textbf{深言科技-语鲸...}}{}
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item 项目描述：基于清华大模型...
  \item 核心职责与产出：参与 AI 搜索链路...
\end{itemize}
\begin{enumerate}[leftmargin=1.6cm,labelsep=0.5em]
  \item Agent 推理与规划...
  \item 多源融合检索架构...
\end{enumerate}
```

**场景二输出（加粗版本）：**
```latex
\datedsubsection{\textbf{腾讯云域名注册业务}}{}
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item \textbf{搜索服务拆分专项}
\end{itemize}
\begin{itemize}[label=$\bullet$,parsep=0.2ex,leftmargin=1.6cm,labelsep=0.5em]
  \item 针对域名Check查询挤占连接资源...
  \item 按读/写属性垂直拆分EPP服务...
  \item 设计公共备用集群作为容灾方案...
\end{itemize}
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item \textbf{域名黑白名单专项}
\end{itemize}
\begin{itemize}[label=$\bullet$,parsep=0.2ex,leftmargin=1.6cm,labelsep=0.5em]
  \item 针对域名秒杀抢注、溢价域名交易...
  \item 多级缓存架构：构建"SDK本地缓存...
  \item 数据一致性保障：实现"准实时-增量...
\end{itemize}
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item \textbf{风险SQL治理专项}
\end{itemize}
\begin{itemize}[label=$\bullet$,parsep=0.2ex,leftmargin=1.6cm,labelsep=0.5em]
  \item 优化100余条高风险SQL...
  \item API优化: 通过强制索引...
  \item 统计查询优化: 采用代码解耦...
  \item RO迁移: 推动复杂查询向RO...
\end{itemize}
```

**场景二输出（不加粗版本）：**
```latex
\datedsubsection{\textbf{腾讯云域名注册业务}}{}
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item 搜索服务拆分专项
\end{itemize}
\begin{itemize}[label=$\bullet$,parsep=0.2ex,leftmargin=1.6cm,labelsep=0.5em]
  \item 针对域名Check查询挤占连接资源...
  \item 按读/写属性垂直拆分EPP服务...
  \item 设计公共备用集群作为容灾方案...
\end{itemize}
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item 域名黑白名单专项
\end{itemize}
\begin{itemize}[label=$\bullet$,parsep=0.2ex,leftmargin=1.6cm,labelsep=0.5em]
  \item 针对域名秒杀抢注、溢价域名交易...
  \item 多级缓存架构：构建"SDK本地缓存...
  \item 数据一致性保障：实现"准实时-增量...
\end{itemize}
\begin{itemize}[label={},parsep=0.2ex,leftmargin=0.8cm,itemindent=0em]
  \item 风险SQL治理专项
\end{itemize}
\begin{itemize}[label=$\bullet$,parsep=0.2ex,leftmargin=1.6cm,labelsep=0.5em]
  \item 优化100余条高风险SQL...
  \item API优化: 通过强制索引...
  \item 统计查询优化: 采用代码解耦...
  \item RO迁移: 推动复杂查询向RO...
\end{itemize}
```

**关键说明**：
- 专项标题的加粗格式（`\textbf{...}`）完全由用户决定，系统会保留原有的加粗格式
- 如果用户设置了加粗，输出中包含 `\textbf{...}`
- 如果用户没有设置加粗，输出中不包含 `\textbf{...}`
- 系统不会强制加粗或去除加粗

## 五、实施计划

### 5.1 实施步骤

1. **第一步**：添加 `is_list_content()` 辅助函数
2. **第二步**：修改 `generate_section_projects` 函数，实现内容分类
3. **第三步**：分别渲染段落和列表，应用不同缩进
4. **第四步**：测试各种内容组合场景
5. **第五步**：验证 PDF 渲染效果

### 5.2 风险评估

- **低风险**：修改范围明确，不影响其他模块
- **中风险**：需要确保列表检测逻辑准确，避免误判
- **缓解措施**：充分测试各种内容格式组合

## 六、总结

本方案通过内容类型识别和分层渲染，实现了项目经验的分层缩进效果。方案具有以下优点：

1. **灵活性**：自动识别内容类型，适应不同数据格式
2. **可维护性**：逻辑清晰，易于理解和修改
3. **兼容性**：不影响现有功能，向后兼容
4. **可扩展性**：如需调整缩进层级，只需修改 leftmargin 参数

