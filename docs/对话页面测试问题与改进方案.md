# Agent å·¥å…·è°ƒç”¨æ¶æ„æ”¹è¿›æ–¹æ¡ˆ

> **æ›´æ–°æ—¥æœŸ**ï¼š2025-12-30
> **æµ‹è¯•é¡µé¢**ï¼šhttp://localhost:5173/conversation
> **åç«¯ API**ï¼šhttp://localhost:8000/api/cv-agent/chat/stream

---

## ä¸€ã€å½“å‰æ¶æ„çŠ¶æ€

### 1.1 åç«¯ API æµ‹è¯•ç»“æœ

âœ… **åç«¯æµå¼ API æ­£å¸¸å·¥ä½œ**

```bash
# æµ‹è¯•å‘½ä»¤
curl -X POST 'http://localhost:8000/api/cv-agent/chat/stream' \
  -H 'Content-Type: application/json' \
  -d '{"message":"æŠŠåå­—æ”¹æˆå¼ ä¸‰","resume_data":{"basic":{"name":"æµ‹è¯•"}}}'
```

**è¿”å›çš„æ¶ˆæ¯ç±»å‹**ï¼š
| ç±»å‹ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `thinking` | æ€è€ƒè¿‡ç¨‹ | âœ… å·²å®ç° |
| `tool_call` | å·¥å…·è°ƒç”¨ä¿¡æ¯ | âœ… å·²å®ç° |
| `tool_start` | å·¥å…·å¼€å§‹æ‰§è¡Œ | âœ… å·²å®ç° |
| `tool_end` | å·¥å…·æ‰§è¡Œç»“æŸ | âœ… å·²å®ç° |
| `tool_result` | å·¥å…·æ‰§è¡Œç»“æœ | âœ… å·²å®ç° |
| `content` | æœ€ç»ˆå›å¤å†…å®¹ | âœ… å·²å®ç° |
| `done` | å®Œæˆæ ‡è®° | âœ… å·²å®ç° |

### 1.2 å‰ç«¯æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ â†’ cvToolsChatStream() â†’ SSE æ¥æ”¶
    â†“
onThinking â†’ æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
onToolCall â†’ æ˜¾ç¤ºå·¥å…·è°ƒç”¨ä¿¡æ¯
onToolStart â†’ æ˜¾ç¤ºå·¥å…·å¼€å§‹æ‰§è¡ŒçŠ¶æ€ï¼ˆæ–°å¢ï¼‰
onToolEnd â†’ æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æŸçŠ¶æ€å’Œæ—¶é•¿ï¼ˆæ–°å¢ï¼‰
onToolResult â†’ æ‰§è¡Œæœ¬åœ°å·¥å…·è°ƒç”¨ â†’ setResumeData()
onContent â†’ æ˜¾ç¤ºæœ€ç»ˆå›å¤
```

### 1.3 å½“å‰å·¥å…·æ”¯æŒ

| å·¥å…· | åŠŸèƒ½ | è·¯å¾„ç¤ºä¾‹ |
|------|------|---------|
| **CVReader** | è¯»å–ç®€å†æ•°æ® | `education`, `basic.name` |
| **CVEditor** | ç¼–è¾‘ç®€å†å­—æ®µ | `basic.name`, `experience[0]` |
| **CVEditor (add)** | æ·»åŠ æ–°é¡¹ | `experience`, `projects` |
| **CVEditor (delete)** | åˆ é™¤é¡¹ | `experience[1]` |

---

## äºŒã€å‘ç°çš„é—®é¢˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

| é—®é¢˜ | ç±»å‹ | å½±å“ | çŠ¶æ€ |
|------|------|------|------|
| **å·¥å…·è°ƒç”¨çŠ¶æ€ä¸å¤Ÿç»†è‡´** | åç«¯ | å‰ç«¯åªçŸ¥é“"æ­£åœ¨æ‰§è¡Œ"ï¼Œæ— æ³•åŒºåˆ†å·¥å…·å¼€å§‹/ç»“æŸ | âœ… å·²è§£å†³ |
| **ç¼ºå°‘æ¾„æ¸…èƒ½åŠ›** | åç«¯ | ä¿¡æ¯ä¸è¶³æ—¶æ— æ³•ä¸»åŠ¨è¯¢é—®ç”¨æˆ· | ğŸ”„ å¾…å®æ–½ |
| **å‰ç«¯æ•°æ®åŒæ­¥ä¾èµ–æœ¬åœ°æ‰§è¡Œ** | å‰ç«¯ | ä¸åç«¯æ•°æ®å¯èƒ½ä¸ä¸€è‡´ | ğŸ”„ å¾…è®¨è®º |
| **ç¼ºå°‘å·¥å…·è°ƒç”¨å†å²** | åç«¯ | æ— æ³•è¿½æº¯ä¹‹å‰çš„å·¥å…·è°ƒç”¨ | ğŸ”„ å¾…å®æ–½ |

---

## ä¸‰ã€æ”¹è¿›æ–¹æ¡ˆï¼ˆä¸“æ³¨ Agent æ ¸å¿ƒåŠŸèƒ½ï¼‰

### 3.1 åç«¯ï¼šå®Œå–„å·¥å…·è°ƒç”¨çŠ¶æ€é€šçŸ¥

**ç›®æ ‡**ï¼šè®©å‰ç«¯æ¸…æ¥šçŸ¥é“å·¥å…·æ‰§è¡Œçš„æ¯ä¸ªé˜¶æ®µ

```python
# backend/agents/message_builder.py

class MessageType(Enum):
    THINKING = "thinking"
    TOOL_CALL = "tool_call"       # å·¥å…·è°ƒç”¨å‚æ•°
    TOOL_START = "tool_start"     # å·¥å…·å¼€å§‹æ‰§è¡Œ
    TOOL_END = "tool_end"         # å·¥å…·æ‰§è¡Œç»“æŸ
    TOOL_RESULT = "tool_result"   # å·¥å…·æ‰§è¡Œç»“æœ
    CONTENT = "content"           # æœ€ç»ˆå›å¤
    ERROR = "error"
    DONE = "done"
```

**å®ç°**ï¼šä¿®æ”¹ `cv_agent.py` ä¸­çš„æµå¼è¾“å‡º

```python
async def _handle_llm_tool_calls_stream(
    self,
    tool_calls: List[Dict],
    session_id: str
) -> AsyncIterator[Dict]:
    """å¤„ç†å·¥å…·è°ƒç”¨ï¼Œè¿”å›æµå¼æ¶ˆæ¯"""

    for tool_call in tool_calls:
        tool_name = tool_call.get("name")
        tool_params = tool_call.get("params", {})

        # 1. å‘é€ tool_callï¼ˆå·¥å…·è°ƒç”¨å‚æ•°ï¼‰
        yield {
            "type": MessageType.TOOL_CALL.value,
            "content": {
                "name": tool_name,
                "params": tool_params
            },
            "session_id": session_id
        }

        # 2. å‘é€ tool_startï¼ˆå·¥å…·å¼€å§‹æ‰§è¡Œï¼‰
        yield {
            "type": MessageType.TOOL_START.value,
            "content": {
                "tool_name": tool_name,
                "action": tool_params.get("action", ""),
                "path": tool_params.get("path", "")
            },
            "session_id": session_id
        }

        # 3. æ‰§è¡Œå·¥å…·
        start_time = time.time()
        result = await self._execute_tool(tool_name, tool_params)
        duration_ms = int((time.time() - start_time) * 1000)

        # 4. å‘é€ tool_endï¼ˆå·¥å…·æ‰§è¡Œç»“æŸï¼‰
        yield {
            "type": MessageType.TOOL_END.value,
            "content": {
                "tool_name": tool_name,
                "success": result.get("success", False),
                "duration_ms": duration_ms
            },
            "session_id": session_id
        }

        # 5. å‘é€ tool_resultï¼ˆå·¥å…·æ‰§è¡Œç»“æœï¼‰
        yield {
            "type": MessageType.TOOL_RESULT.value,
            "content": {
                "success": result.get("success", False),
                "tool_name": tool_name,
                "tool_params": tool_params,
                "result": result.get("result"),
                "error": result.get("error"),
                "duration_ms": duration_ms
            },
            "session_id": session_id
        }
```

### 3.2 åç«¯ï¼šæ·»åŠ æ¾„æ¸…/è¡¥å……ä¿¡æ¯èƒ½åŠ›

**ç›®æ ‡**ï¼šå½“ç”¨æˆ·è¾“å…¥ä¿¡æ¯ä¸å®Œæ•´æ—¶ï¼Œä¸»åŠ¨è¯¢é—®ç¼ºå¤±ä¿¡æ¯

```python
# backend/agents/clarification.py

from dataclasses import dataclass
from typing import List, Optional

@dataclass
class ClarificationRequest:
    """æ¾„æ¸…è¯·æ±‚"""
    module: str          # workExperience, education, project
    missing_fields: List[str]
    prompt: str
    examples: Optional[List[str]] = None

class ClarificationDetector:
    """ä¿¡æ¯å®Œæ•´æ€§æ£€æµ‹å™¨"""

    def check_work_experience(self, data: Dict) -> Optional[ClarificationRequest]:
        """æ£€æŸ¥å·¥ä½œç»å†ä¿¡æ¯å®Œæ•´æ€§"""
        required = ["company", "position"]
        missing = [f for f in required if not data.get(f)]

        if missing:
            return ClarificationRequest(
                module="workExperience",
                missing_fields=missing,
                prompt=f"è¯·è¡¥å……å·¥ä½œç»å†çš„ä¿¡æ¯ï¼š{', '.join(missing)}",
                examples=[
                    "å…¬å¸ï¼šè…¾è®¯ç§‘æŠ€æœ‰é™å…¬å¸",
                    "èŒä½ï¼šå‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ",
                ]
            )
        return None

    def check_education(self, data: Dict) -> Optional[ClarificationRequest]:
        """æ£€æŸ¥æ•™è‚²ç»å†ä¿¡æ¯å®Œæ•´æ€§"""
        required = ["school", "major"]
        missing = [f for f in required if not data.get(f)]

        if missing:
            return ClarificationRequest(
                module="education",
                missing_fields=missing,
                prompt=f"è¯·è¡¥å……æ•™è‚²ç»å†çš„ä¿¡æ¯ï¼š{', '.join(missing)}",
                examples=[
                    "å­¦æ ¡ï¼šæ¸…åå¤§å­¦",
                    "ä¸“ä¸šï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯",
                ]
            )
        return None
```

**åœ¨ CVAgent ä¸­é›†æˆ**ï¼š

```python
# backend/agents/cv_agent.py

async def process_message_stream(self, message: str) -> AsyncIterator[Dict]:
    """æµå¼å¤„ç†ç”¨æˆ·æ¶ˆæ¯"""

    # 1. æ„å›¾è¯†åˆ«
    intent = await self._recognize_intent(message)

    # 2. å¦‚æœæ˜¯æ·»åŠ æ“ä½œï¼Œæ£€æŸ¥ä¿¡æ¯å®Œæ•´æ€§
    if intent.action == "add":
        clarification = self.clarification_detector.check(intent.module, intent.extracted_data)
        if clarification:
            # è¿”å›æ¾„æ¸…è¯·æ±‚
            yield {
                "type": "clarify",
                "content": {
                    "prompt": clarification.prompt,
                    "missing_fields": clarification.missing_fields,
                    "examples": clarification.examples
                },
                "session_id": self.session_id
            }
            return

    # 3. ä¿¡æ¯å®Œæ•´ï¼Œç»§ç»­æ‰§è¡Œå·¥å…·è°ƒç”¨
    async for msg in self._execute_with_streaming(intent):
        yield msg
```

### 3.3 å‰ç«¯ï¼šå¤„ç†æ–°çš„æ¶ˆæ¯ç±»å‹

**æ›´æ–° API è°ƒç”¨**ï¼š

```typescript
// frontend/src/services/api.ts

export async function cvToolsChatStream(
  message: string,
  resumeData: Record<string, unknown>,
  sessionId: string | undefined,
  callbacks: {
    onThinking?: (thinking: string) => void
    onToolCall?: (toolCall: { name: string; params: any }) => void
    onToolStart?: (info: { tool_name: string; action: string; path: string }) => void  // æ–°å¢
    onToolEnd?: (info: { tool_name: string; success: boolean; duration_ms: number }) => void  // æ–°å¢
    onToolResult?: (result: any) => void
    onClarify?: (clarify: { prompt: string; missing_fields: string[]; examples: string[] }) => void  // æ–°å¢
    onContent?: (content: string, metadata?: any) => void
    onComplete?: (sessionId: string) => void
    onError?: (error: string) => void
  }
) {
  // ... ç°æœ‰ä»£ç 

  const processLine = (line: string) => {
    // ... ç°æœ‰è§£æé€»è¾‘

    if (parsed.type === 'tool_start') {
      callbacks.onToolStart?.(parsed.content)
    } else if (parsed.type === 'tool_end') {
      callbacks.onToolEnd?.(parsed.content)
    } else if (parsed.type === 'clarify') {
      callbacks.onClarify?.(parsed.content)
    }
    // ... å…¶ä»–ç±»å‹
  }
}
```

**æ›´æ–° CVToolsTest ç»„ä»¶**ï¼š

```tsx
// frontend/src/pages/CVToolsTest/index.tsx

interface Message {
  id: string
  role: 'user' | 'assistant' | 'system'
  content: string
  timestamp: number
  toolCall?: ToolCall
  toolResult?: ToolResult
  reasoning?: string
  toolStatus?: 'executing' | 'success' | 'error'  // æ–°å¢
  clarify?: {  // æ–°å¢
    prompt: string
    missing_fields: string[]
    examples: string[]
  }
}

// åœ¨ handleNaturalLanguage ä¸­å¤„ç†æ–°å›è°ƒ
await cvToolsChatStream(
  message,
  resumeData as unknown as Record<string, unknown>,
  sessionIdRef.current,
  {
    onThinking: (thinking) => { /* ... */ },
    onToolCall: (toolCall) => { /* ... */ },
    onToolStart: (info) => {
      // æ˜¾ç¤ºå·¥å…·å¼€å§‹æ‰§è¡ŒçŠ¶æ€
      setMessages(prev => prev.map(msg =>
        msg.id === assistantMsgId
          ? { ...msg, toolStatus: 'executing', content: `æ­£åœ¨æ‰§è¡Œ ${info.tool_name}...` }
          : msg
      ))
    },
    onToolEnd: (info) => {
      // æ›´æ–°å·¥å…·æ‰§è¡Œç»“æŸçŠ¶æ€
      setMessages(prev => prev.map(msg =>
        msg.id === assistantMsgId
          ? {
              ...msg,
              toolStatus: info.success ? 'success' : 'error',
              content: `${info.tool_name} ${info.success ? 'æ‰§è¡ŒæˆåŠŸ' : 'æ‰§è¡Œå¤±è´¥'} (${info.duration_ms}ms)`
            }
          : msg
      ))
    },
    onToolResult: (result) => { /* ... */ },
    onClarify: (clarify) => {
      // æ˜¾ç¤ºæ¾„æ¸…è¯·æ±‚
      setMessages(prev => [...prev, {
        id: `clarify-${Date.now()}`,
        role: 'assistant',
        content: clarify.prompt,
        clarify,
        timestamp: Date.now()
      }])
    },
    onContent: (content) => { /* ... */ },
    onComplete: (sessionId) => { /* ... */ },
    onError: (error) => { /* ... */ }
  }
)
```

### 3.4 åç«¯ï¼šå¢å¼ºå·¥å…·èƒ½åŠ›

**å½“å‰å·¥å…·é™åˆ¶**ï¼š

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| åªèƒ½æ›´æ–°å•ä¸ªå­—æ®µ | æ”¯æŒæ‰¹é‡æ›´æ–° |
| ç¼ºå°‘æ™ºèƒ½è§£æ | å¢å¼º LLM æå–èƒ½åŠ› |
| æ²¡æœ‰å†å²è¿½æº¯ | æ·»åŠ æ“ä½œæ—¥å¿— |

**æ–°å¢å·¥å…·ï¼šCVBatchEditor**

```python
# backend/agents/tools/cv_batch_editor.py

class CVBatchEditor:
    """æ‰¹é‡ç¼–è¾‘å·¥å…·"""

    name = "CVBatchEditor"

    async def execute(self, params: Dict) -> Dict:
        """
        æ‰¹é‡æ‰§è¡Œå¤šä¸ªç¼–è¾‘æ“ä½œ

        params:
            operations: List[Dict]  # æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ª CVEditor æ“ä½œ
        """
        operations = params.get("operations", [])
        results = []

        for op in operations:
            result = await self._execute_single(op)
            results.append(result)

        return {
            "success": True,
            "results": results,
            "total": len(operations),
            "succeeded": sum(1 for r in results if r.get("success")),
            "failed": sum(1 for r in results if not r.get("success"))
        }
```

---

## å››ã€å®æ–½è®¡åˆ’

### 4.1 ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¾èµ– | çŠ¶æ€ |
|-------|------|---------|------|------|
| **P0** | åç«¯æ·»åŠ  tool_start/tool_end æ¶ˆæ¯ | 1 å¤© | æ—  | âœ… å·²å®Œæˆ |
| **P1** | å‰ç«¯å¤„ç† tool_start/tool_end | 0.5 å¤© | P0 | âœ… å·²å®Œæˆ |
| **P2** | å®ç°æ¾„æ¸…èƒ½åŠ› | 2 å¤© | æ—  | âœ… å·²å®Œæˆ |
| **P3** | å‰ç«¯å¤„ç†æ¾„æ¸…æ¶ˆæ¯ | 1 å¤© | P2 | âœ… å·²å®Œæˆ |
| **P4** | å¢å¼ºå·¥å…·èƒ½åŠ›ï¼ˆæ‰¹é‡æ“ä½œï¼‰ | 1 å¤© | æ—  | âœ… å·²å®Œæˆ |

### 4.2 å®æ–½é¡ºåº

```
ç¬¬ 1 æ­¥ï¼šåç«¯ tool_start/tool_end  âœ… å·²å®Œæˆ
    â†“
ç¬¬ 2 æ­¥ï¼šå‰ç«¯çŠ¶æ€æ˜¾ç¤º  âœ… å·²å®Œæˆ
    â†“
ç¬¬ 3 æ­¥ï¼šæ¾„æ¸…èƒ½åŠ›ï¼ˆåç«¯ + å‰ç«¯ï¼‰  âœ… å·²å®Œæˆ
    â†“
ç¬¬ 4 æ­¥ï¼šæ‰¹é‡ç¼–è¾‘å·¥å…·  âœ… å·²å®Œæˆ
```

### 4.3 å·²å®Œæˆçš„æ”¹è¿›

**åç«¯**ï¼š
- `message_builder.py`ï¼šæ·»åŠ  `TOOL_START`, `TOOL_END`, `THINKING`, `CONTENT`, `DONE` æ¶ˆæ¯ç±»å‹
- `cv_agent.py`ï¼šåœ¨ `_handle_llm_tool_calls_stream` ä¸­æ·»åŠ å·¥å…·æ‰§è¡Œè®¡æ—¶å’ŒçŠ¶æ€é€šçŸ¥
- `cv_agent.py`ï¼šåœ¨ `_execute_llm_tool` ä¸­æ·»åŠ ä¿¡æ¯å®Œæ•´æ€§æ£€æŸ¥ï¼ˆæ¾„æ¸…èƒ½åŠ›ï¼‰
- æ‰€æœ‰ `yield` æ¶ˆæ¯éƒ½åŒ…å« `session_id`
- `tools/cv_batch_editor.py`ï¼šæ–°å¢ CVBatchEditor æ‰¹é‡ç¼–è¾‘å·¥å…·

**å‰ç«¯**ï¼š
- `api.ts`ï¼šæ·»åŠ  `onToolStart`, `onToolEnd`, `onClarify` å›è°ƒ
- `CVToolsTest/index.tsx`ï¼šæ·»åŠ  `toolStatus`, `toolDuration`, `clarify` å­—æ®µï¼Œæ˜¾ç¤ºå·¥å…·æ‰§è¡ŒçŠ¶æ€å’Œæ¾„æ¸…è¯·æ±‚
- `tools/cvTools.ts`ï¼šæ·»åŠ  `executeBatchOperations` å‡½æ•°æ”¯æŒæ‰¹é‡ç¼–è¾‘

**æµ‹è¯•ç»“æœ**ï¼š
```bash
event: tool_start
data: {"type": "tool_start", "content": {"tool_name": "CVEditor", "action": "update", "path": "basic.name"}}

event: tool_end
data: {"type": "tool_end", "content": {"tool_name": "CVEditor", "success": true, "duration_ms": 0}}
```

---

## äº”ã€å½“å‰ä»£ç ä½ç½®å‚è€ƒ

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|------|---------|
| **åç«¯æµå¼ API** | `backend/routes/cv_agent.py:85-150` |
| **CVAgent æ ¸å¿ƒé€»è¾‘** | `backend/agents/cv_agent.py:220-1750` |
| **å·¥å…·å®šä¹‰** | `backend/agents/cv_agent.py:LLM_TOOLS_DEFINITION` |
| **CVReader å·¥å…·** | `backend/agents/tools/cv_reader.py` |
| **CVEditor å·¥å…·** | `backend/agents/tools/cv_editor.py` |
| **CVBatchEditor å·¥å…·** | `backend/agents/tools/cv_batch_editor.py` |
| **å‰ç«¯ API è°ƒç”¨** | `frontend/src/services/api.ts:633-780` |
| **å‰ç«¯å¯¹è¯é¡µé¢** | `frontend/src/pages/CVToolsTest/index.tsx` |
| **å‰ç«¯å·¥å…·æ‰§è¡Œ** | `frontend/src/tools/cvTools.ts:474-570` |

---

## å…­ã€æ€»ç»“

### å½“å‰çŠ¶æ€

âœ… **å·²å®ç°**ï¼š
- åŸºç¡€æµå¼å¯¹è¯
- CVReader / CVEditor å·¥å…·
- CVBatchEditor æ‰¹é‡ç¼–è¾‘å·¥å…·
- å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ä¿æŒ
- **å·¥å…·æ‰§è¡Œç»†ç²’åº¦çŠ¶æ€é€šçŸ¥**ï¼ˆtool_start/tool_endï¼‰
- **ä¿¡æ¯å®Œæ•´æ€§æ£€æŸ¥å’Œæ¾„æ¸…è¯·æ±‚**ï¼ˆclarifyï¼‰

### æ ¸å¿ƒæ”¹è¿›ç›®æ ‡

1. **æ›´é€æ˜çš„å·¥å…·è°ƒç”¨** - âœ… ç”¨æˆ·æ¸…æ¥šçŸ¥é“æ¯ä¸ªå·¥å…·çš„æ‰§è¡ŒçŠ¶æ€
2. **æ›´æ™ºèƒ½çš„äº¤äº’** - âœ… ä¿¡æ¯ä¸è¶³æ—¶ä¸»åŠ¨è¯¢é—®
3. **æ›´å¼ºå¤§çš„å·¥å…·** - âœ… æ”¯æŒæ‰¹é‡æ“ä½œå’Œå¤æ‚åœºæ™¯

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.0ï¼ˆå…¨éƒ¨æ”¹è¿›å·²å®Œæˆï¼‰
**æœ€åæ›´æ–°**ï¼š2025-12-30
