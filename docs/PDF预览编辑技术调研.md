# PDF 预览内编辑功能技术调研方案

## 1. 背景与目标

当前系统已具备 LaTeX 生成 PDF 及 PDF 预览功能。为进一步提升用户体验，需调研在 Web 端实现 PDF 预览并直接进行编辑修改的技术方案。目标是实现类似夸克扫描王、Adobe Acrobat Web 版的“所见即所得”编辑体验。

## 2. 业界主流产品分析

### 2.1 夸克扫描王 / 夸克浏览器
- **核心体验**：支持 PDF 转 Word/Docx 编辑，或在 PDF 上直接进行涂抹、签名、添加文本。
- **技术推测**：
  - **编辑模式**：采用 OCR (光学字符识别) + Layout Analysis (版面分析)，将 PDF 图像逆向还原为可编辑的结构化文档（DOM/Canvas 对象）。
  - **涂鸦模式**：基于 Canvas 图层叠加，不修改 PDF 原文，保存时将涂鸦层合并入 PDF。

### 2.2 WPS / 腾讯文档 / 石墨文档
- **核心体验**：导入 PDF 后，解析为在线文档格式进行编辑。
- **技术路径**：PDF 解析 -> 中间格式 (JSON/HTML) -> 在线编辑器 -> 导出 PDF。重点在于高精度的格式还原引擎。

### 2.3 Adobe Acrobat Web
- **核心体验**：直接修改 PDF 原文（改字、换图）。
- **技术路径**：基于 WebAssembly 的核心 PDF 引擎，直接操作 PDF 的 Content Stream，处理复杂的字体子集嵌入和流重排问题。

## 3. 技术实现路径

在 Web 端实现 PDF 编辑主要有三种技术路径，难度与效果各异：

### 路径一：增量覆盖模式 (Overlay / Annotation) —— **最推荐**
- **原理**：使用 PDF.js 渲染 PDF 底图，在上方覆盖一层透明的 Canvas 或 DOM 层用于交互。
- **编辑逻辑**：
  - **新增内容**：直接在覆盖层添加文本框、图片、签名。
  - **修改内容**：在原有文字位置覆盖一个背景色（白色）矩形遮挡原文，并在上方绘制新文字。
- **优点**：实现难度低，完全兼容现有 PDF.js 方案，保持原文档排版不乱。
- **缺点**：本质是“打补丁”，对于大段文字的自动换行、流重排支持较差。

### 路径二：格式转换模式 (Conversion)
- **原理**：利用后端工具（如 `pdf2htmlEX` 或 AI OCR）将 PDF 转换为 HTML/Word，在富文本编辑器中编辑，最后打印回 PDF。
- **优点**：编辑体验最接近 Word，支持大幅度重排。
- **缺点**：转换过程极易丢失格式（字体、间距、复杂表格），“回炉”生成的 PDF 可能与原版差异大。

### 路径三：原生流编辑模式 (Native Editing)
- **原理**：解析 PDF 二进制结构，直接修改指令流。
- **优点**：真正的 PDF 编辑。
- **缺点**：技术门槛极高，开源界缺乏成熟的 JS 库支持复杂的文字重排（Reflow），通常需要购买商业 SDK（如 Foxit, PSPDFKit）。

## 4. 开源技术选型对比

| 库名称 | 类型 | 主要功能 | 适用场景 | 优点 | 缺点 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **PDF.js** | 渲染器 | 解析与渲染 PDF | 预览底图 | Mozilla 出品，标准，兼容性好 | **只读**，不支持写入/生成 |
| **pdf-lib** | 生成器 | 创建、修改 PDF | 保存编辑结果 | 纯 JS，支持增量修改、表单填写 | 不支持复杂的文本布局（需手动计算坐标） |
| **react-pdf** | 封装库 | PDF.js 的 React 封装 | 快速集成预览 | 易用，React 友好 | 继承了 PDF.js 的只读限制 |
| **Fabric.js** | 绘图库 | Canvas 交互对象 | 编辑覆盖层 | 强大的对象操作（拖拽、缩放） | 需自行实现与 PDF 坐标系的映射 |
| **MuPDF.js** | 引擎 | Wasm 版 PDF 引擎 | 高级渲染与操作 | 高性能，功能全 | 文档较少，集成复杂度高 |

## 5. 推荐方案：基于 PDF.js + Fabric.js + pdf-lib 的混合编辑方案

针对简历场景（通常是微调文字、签名、标注），**路径一（增量覆盖）** 是性价比最高的方案。

### 5.1 架构设计
1. **渲染层 (View)**: 使用 **PDF.js** 将 PDF 每一页渲染为 Canvas 图片。
2. **交互层 (Interaction)**: 使用 **Fabric.js** 在每一页上方创建一个同等大小的 Canvas。
   - 用户点击文字时，在对应位置生成可编辑文本框。
3. **合成层 (Save)**: 使用 **pdf-lib** 在前端生成新的 PDF。
   - 读取原 PDF。
   - 遍历 Fabric.js 的对象（新增的文字、图片）。
   - 如果是“修改”文字，先在原 PDF 对应坐标画白色矩形遮盖，再写入新文字。
   - 导出新的二进制流。

### 5.2 核心流程
1. **导入**：加载 PDF，计算每一页尺寸。
2. **文本识别（可选优化）**：
   - 利用 PDF.js 的 `getTextContent()` 获取文字坐标层。
   - 当鼠标悬停在文字上时，高亮显示。
   - 点击时，隐藏原文字层，在相同位置实例化一个 Fabric.js `IText` 对象供用户编辑。
3. **编辑**：用户在 Canvas 上拖拽、修改内容。
4. **导出**：将 Canvas 上的变动映射回 PDF 坐标系，调用 `pdf-lib` 写入。

## 6. 可行性分析

### 6.1 优势
- **技术栈匹配**：项目是 React + TypeScript，这些库都有良好的支持。
- **无需后端**：所有操作均在浏览器端完成，保护用户隐私，减轻服务器压力。
- **灵活性**：不仅支持改字，还天然支持画笔、贴图等功能。

### 6.2 风险与挑战
- **字体兼容性**：浏览器端修改 PDF 时，如果原 PDF 使用了特殊字体且未嵌入，`pdf-lib` 写入新文字时可能无法匹配原字体（通常只能用标准字体或加载自定义字体文件）。
  - *解决*：允许用户上传字体，或提供几种标准中文字体。
- **文字排版**：`pdf-lib` 不支持自动换行，长文本修改需要自己计算换行逻辑。
- **坐标系转换**：屏幕像素 (px) 与 PDF 点 (pt) 之间的转换需要精确计算，否则会出现错位。

## 7. 结论

建议采用 **PDF.js (渲染) + Fabric.js (交互) + pdf-lib (生成)** 的组合方案。这是目前开源界最成熟、成本最低的 Web 端 PDF 编辑实现路径，能够满足简历微调、签名、标注等核心需求。
