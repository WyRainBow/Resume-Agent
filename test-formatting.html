<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能排版功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-input {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 10px 0;
        }
        .test-output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            padding: 10px;
            background: #d4edda;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>AI 智能排版功能测试</h1>

    <div class="test-section">
        <h2>测试 1: 紧凑格式 → 段落格式</h2>
        <p>输入紧凑格式的技能文本，测试是否能正确转换为段落格式</p>
        <textarea class="test-input" id="compact-input">后端: 熟悉若干编程语言或服务框架 数据库: 了解常见数据库及调优思路 缓存: 掌握缓存策略与典型问题处理</textarea>
        <button onclick="testCompactToParagraph()">测试转换</button>
        <div id="compact-output" class="test-output"></div>
    </div>

    <div class="test-section">
        <h2>测试 2: 段落格式 → 列表格式</h2>
        <p>输入段落格式的技能文本，测试是否能转换为列表格式</p>
        <textarea class="test-input" id="paragraph-input"><p>后端: 熟悉若干编程语言或服务框架</p><p>数据库: 了解常见数据库及调优思路</p><p>缓存: 掌握缓存策略与典型问题处理</p></textarea>
        <button onclick="testParagraphToList()">测试转换为无序列表</button>
        <button onclick="testParagraphToOrderedList()">测试转换为有序列表</button>
        <div id="paragraph-output" class="test-output"></div>
    </div>

    <div class="test-section">
        <h2>测试 3: 列表格式 → 段落格式</h2>
        <p>输入列表格式的技能文本，测试是否能转换为段落格式</p>
        <textarea class="test-input" id="list-input"><ul><li>后端: 熟悉若干编程语言或服务框架</li><li>数据库: 了解常见数据库及调优思路</li><li>缓存: 掌握缓存策略与典型问题处理</li></ul></textarea>
        <button onclick="testListToParagraph()">测试转换</button>
        <div id="list-output" class="test-output"></div>
    </div>

    <div class="test-section">
        <h2>测试 4: AI 增强功能</h2>
        <p>测试 AI 增强是否正常工作（需要有后端服务）</p>
        <textarea class="test-input" id="ai-input">后端: 熟悉若干编程语言或服务框架 数据库: 了解常见数据库及调优思路</textarea>
        <button onclick="testAIEnhancement()">测试 AI 增强</button>
        <div id="ai-output" class="test-output"></div>
    </div>

    <div id="messages"></div>

    <script type="module">
        // 模拟格式化工具函数
        function extractTextFromHTML(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        function isSkillFormat(text) {
            const skillPattern = /^[^:]+:\s*.+/;
            const lines = text.split('\n').filter(line => line.trim());

            if (lines.length === 0) return false;

            const matchedLines = lines.filter(line => skillPattern.test(line.trim()));
            return matchedLines.length >= Math.ceil(lines.length * 0.5);
        }

        function splitCompactSkills(text) {
            const skillPattern = /([^:]+):\s*([^:]+?)(?=\s+[^:]+:|$)/g;
            const skills = [];
            let match;

            while ((match = skillPattern.exec(text)) !== null) {
                const category = match[1].trim();
                const description = match[2].trim();
                if (category && description) {
                    skills.push(`${category}: ${description}`);
                }
            }

            if (skills.length === 0) {
                const colonIndices = [];
                for (let i = 0; i < text.length; i++) {
                    if (text[i] === ':' && i > 0 && text[i - 1] !== ' ' && i < text.length - 1 && text[i + 1] === ' ') {
                        colonIndices.push(i);
                    }
                }

                if (colonIndices.length > 0) {
                    for (let i = 0; i < colonIndices.length; i++) {
                        const start = i === 0 ? 0 : colonIndices[i - 1] + 1;
                        const end = i === colonIndices.length - 1 ? text.length : colonIndices[i];
                        const skill = text.substring(start, end).trim();
                        if (skill) {
                            skills.push(skill);
                        }
                    }
                }
            }

            return skills.length > 0 ? skills : [text];
        }

        function detectContentFormat(html) {
            if (!html || !html.trim()) return 'unknown';

            const hasList = /<ul[^>]*>|<\/ul>|<ol[^>]*>|<\/ol>|<li[^>]*>|<\/li>/i.test(html);
            if (hasList) return 'list';

            const text = extractTextFromHTML(html);
            const lines = text.split('\n').filter(line => line.trim());

            if (lines.length > 1 && isSkillFormat(text)) {
                return 'paragraph';
            }

            if (lines.length <= 2) {
                const skillCount = splitCompactSkills(text).length;
                if (skillCount > 1) {
                    return 'compact';
                }
            }

            if (isSkillFormat(text)) {
                return 'paragraph';
            }

            return 'unknown';
        }

        function convertLinesToParagraphs(lines) {
            return lines
                .map(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return '';

                    if (trimmed.includes('<')) {
                        return `<p>${trimmed}</p>`;
                    }

                    const escaped = trimmed
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');

                    return `<p>${escaped}</p>`;
                })
                .filter(p => p)
                .join('\n');
        }

        function convertParagraphsToList(html, ordered = false) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const paragraphs = tempDiv.querySelectorAll('p');
            const listItems = [];

            paragraphs.forEach((p) => {
                const content = p.innerHTML.trim();
                if (content) {
                    listItems.push(`<li>${content}</li>`);
                }
            });

            if (listItems.length === 0) {
                const text = extractTextFromHTML(html);
                const lines = text.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    listItems.push(`<li>${line.trim()}</li>`);
                });
            }

            const listTag = ordered ? 'ol' : 'ul';
            return `<${listTag}>\n${listItems.join('\n')}\n</${listTag}>`;
        }

        function parseListToParagraphs(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const listItems = tempDiv.querySelectorAll('ul li, ol li');

            if (listItems.length === 0) {
                const text = extractTextFromHTML(html);
                const lines = text.split('\n').filter(line => line.trim());
                return convertLinesToParagraphs(lines);
            }

            const paragraphs = [];

            listItems.forEach((li) => {
                const content = li.innerHTML.trim();

                if (content) {
                    if (content.includes('<p>')) {
                        paragraphs.push(content);
                    } else {
                        paragraphs.push(`<p>${content}</p>`);
                    }
                }
            });

            return paragraphs.join('\n');
        }

        function formatLayoutByRules(html, targetFormat = 'auto', ordered = false) {
            if (!html || !html.trim()) {
                return html;
            }

            try {
                const currentFormat = detectContentFormat(html);
                console.log(`检测到格式: ${currentFormat}`);

                if (targetFormat === 'auto') {
                    if (currentFormat === 'list') {
                        targetFormat = 'paragraph';
                    } else if (currentFormat === 'paragraph') {
                        targetFormat = 'list';
                    } else if (currentFormat === 'compact') {
                        targetFormat = 'paragraph';
                    } else {
                        targetFormat = 'paragraph';
                    }
                }

                console.log(`目标格式: ${targetFormat}`);

                if (targetFormat === 'list') {
                    if (currentFormat === 'list') {
                        return convertParagraphsToList(parseListToParagraphs(html), ordered);
                    } else {
                        const text = extractTextFromHTML(html);
                        if (currentFormat === 'compact') {
                            const skills = splitCompactSkills(text);
                            const listItems = skills.map(skill => `<li>${skill}</li>`).join('\n');
                            return ordered ? `<ol>\n${listItems}\n</ol>` : `<ul>\n${listItems}\n</ul>`;
                        } else {
                            return convertParagraphsToList(html, ordered);
                        }
                    }
                } else {
                    if (currentFormat === 'list') {
                        return parseListToParagraphs(html);
                    } else if (currentFormat === 'compact') {
                        const text = extractTextFromHTML(html);
                        const skills = splitCompactSkills(text);
                        return convertLinesToParagraphs(skills);
                    } else if (currentFormat === 'paragraph') {
                        return html;
                    } else {
                        const text = extractTextFromHTML(html);
                        if (isSkillFormat(text)) {
                            const lines = text.split('\n').filter(line => line.trim());
                            return convertLinesToParagraphs(lines);
                        }
                        return html;
                    }
                }
            } catch (error) {
                console.error('格式化失败:', error);
                return html;
            }
        }

        // 暴露给全局的测试函数
        window.testCompactToParagraph = function() {
            const input = document.getElementById('compact-input').value;
            const output = formatLayoutByRules(input, 'paragraph');
            document.getElementById('compact-output').innerHTML = output;
            showMessage('success', '紧凑格式 → 段落格式 转换成功');
        };

        window.testParagraphToList = function() {
            const input = document.getElementById('paragraph-input').value;
            const output = formatLayoutByRules(input, 'list', false);
            document.getElementById('paragraph-output').innerHTML = output;
            showMessage('success', '段落格式 → 无序列表 转换成功');
        };

        window.testParagraphToOrderedList = function() {
            const input = document.getElementById('paragraph-input').value;
            const output = formatLayoutByRules(input, 'list', true);
            document.getElementById('paragraph-output').innerHTML = output;
            showMessage('success', '段落格式 → 有序列表 转换成功');
        };

        window.testListToParagraph = function() {
            const input = document.getElementById('list-input').value;
            const output = formatLayoutByRules(input, 'paragraph');
            document.getElementById('list-output').innerHTML = output;
            showMessage('success', '列表格式 → 段落格式 转换成功');
        };

        window.testAIEnhancement = async function() {
            const input = document.getElementById('ai-input').value;
            const outputDiv = document.getElementById('ai-output');

            try {
                const response = await fetch('http://localhost:8000/api/resume/rewrite/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'doubao',
                        resume: { skillContent: input },
                        path: 'skillContent',
                        instruction: '请将以下紧凑格式转换为段落格式：' + input
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body?.getReader();
                const decoder = new TextDecoder();

                if (!reader) {
                    throw new Error('无法获取响应流');
                }

                let result = '';
                outputDiv.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                showMessage('success', 'AI 增强完成');
                                return;
                            }
                            try {
                                const parsed = JSON.parse(data);
                                result += parsed.content || '';
                                outputDiv.innerHTML = result;
                            } catch (e) {
                                console.error('解析数据失败:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('AI 增强失败:', error);
                showMessage('error', `AI 增强失败: ${error.message}`);
            }
        };

        function showMessage(type, message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messagesDiv.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // 初始测试
        console.log('页面加载完成，准备测试智能排版功能');
    </script>
</body>
</html>